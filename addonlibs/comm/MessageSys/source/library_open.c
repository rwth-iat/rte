
/******************************************************************************
 *
 *   FILE
 *   ----
 *   library_open.c
 *
 *   Author: C. Hansen, D. Kampert
 *
 *   History
 *   -------
 *   2012-10-19   File created
 *
 *******************************************************************************
 *
 *   This file is generated by the 'acplt_builder' command
 *
 ******************************************************************************/

#ifndef OV_COMPILE_LIBRARY_MessageSys
#define OV_COMPILE_LIBRARY_MessageSys
#endif

#include "MessageSys.h"
#include "MessageSys_helpers.h"
#include "libov/ov_macros.h"
#include "libov/ov_logfile.h"
#include "libov/ov_path.h"
#include "libov/ov_time.h"
#include "libov/ov_result.h"
#include "libov/ov_library.h"

#ifdef ov_library_open_MessageSys
#undef ov_library_open_MessageSys
#endif

/*
 * This function will be called, when the library is loaded.
 * It could generate components and initializes the startup procedure
 */
OV_RESULT ov_library_setglobalvars_MessageSys_new(void) {
	OV_RESULT result;
	OV_INSTPTR_ov_domain domain = NULL;
	OV_INSTPTR_MessageSys_MsgDelivery		MsgSysDelivery  =	NULL;
	OV_INSTPTR_ov_library					pLibKsapi		=	NULL;
	OV_INSTPTR_MessageSys_msgIdentificator	pIdentificator	=	NULL;
	/*
	 *    set the global variables of the original version
	 *    and if successful, load other libraries
	 *    and create some objects
	 */

	result = ov_library_setglobalvars_MessageSys();

	ov_memstack_lock();

	/*	check if ksapi is loaded	*/
	Ov_ForEachChildEx(ov_instantiation, pclass_ov_library, pLibKsapi, ov_library)
	{
		if(ov_string_compare(pLibKsapi->v_identifier, "ksapi") == OV_STRCMP_EQUAL)
		{
			break;
		}
	}
	if(!pLibKsapi)
	{
		result = Ov_CreateObject(ov_library, pLibKsapi, &(pdb->acplt), "ksapi");
		if(Ov_Fail(result)){
			ov_memstack_lock();
			ov_logfile_error("messageSys: Fatal: Couldn't load dependency \"ksapi\" Reason: %s", ov_result_getresulttext(result));
			ov_memstack_unlock();
			return result;
		}
	}


	//MsgDelivery
	domain = (OV_INSTPTR_ov_domain)ov_path_getobjectpointer(COMPATH, 2);
	MsgSysDelivery=Ov_DynamicPtrCast(MessageSys_MsgDelivery, Ov_SearchChild(ov_containment,domain,"MessageSys"));
	if(MsgSysDelivery==NULL){
		result = Ov_CreateObject(MessageSys_MsgDelivery, MsgSysDelivery, domain, "MessageSys");
		if(Ov_Fail(result) && (result != OV_ERR_ALREADYEXISTS)){
			ov_memstack_lock();
			ov_logfile_error("messageSys: Fatal: Couldn't create Object 'MessageSys' Reason: %s", ov_result_getresulttext(result));
			ov_memstack_unlock();
			return result;
		}
		if(Ov_OK(result))
			MsgSysDelivery->v_cycInterval = 1;
	}
	/*	create protocol identificator for msgs	*/
	pIdentificator = Ov_StaticPtrCast(MessageSys_msgIdentificator, Ov_SearchChild(ov_containment, MsgSysDelivery, "Identificator"));
	if(pIdentificator)
		Ov_DeleteObject(pIdentificator);
	pIdentificator = NULL;

	result = Ov_CreateObject(MessageSys_msgIdentificator, pIdentificator, MsgSysDelivery, "Identificator");
	if(Ov_Fail(result))
	{
		ov_logfile_error("Fatal: could not create Identificator object");
		return result;
	}

	ov_memstack_unlock();
	return OV_ERR_OK;
}
/*
 *       Replace the 'setglobalvars' function of a library with this
 *       previous one, which additionally creates instances.
 * 	This is called by the OV system upon library load.
 */
OV_DLLFNCEXPORT OV_LIBRARY_DEF *ov_library_open_MessageSys(void) {
	/* local variables */
	static OV_LIBRARY_DEF *OV_LIBRARY_DEF_MessageSys_new;


	/*
	 *       replace the 'setglobalvars' function created by the code generator
	 *       with a new one.
	 */
	OV_LIBRARY_DEF_MessageSys_new = ov_library_open_MessageSys_old();
	OV_LIBRARY_DEF_MessageSys_new->setglobalvarsfnc = ov_library_setglobalvars_MessageSys_new;
	return OV_LIBRARY_DEF_MessageSys_new;
}
