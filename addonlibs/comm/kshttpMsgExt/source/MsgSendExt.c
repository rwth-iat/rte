
/******************************************************************************
*
*   FILE
*   ----
*   MsgSendExt.c
*
*   History
*   -------
*   2014-11-12   File created
*
*******************************************************************************
*
*   This file is generated by the 'acplt_builder' command
*
******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_kshttpMsgExt
#define OV_COMPILE_LIBRARY_kshttpMsgExt
#endif


#include "kshttpMsgExt.h"
#include "libov/ov_macros.h"
#include "libov/ov_path.h"
#include "libov/ov_memstack.h"
#include "libov/ov_result.h"
#include "ksbase_helper.h"
#include "ks_logfile.h"


OV_DLLFNCEXPORT OV_RESULT kshttpMsgExt_MsgSendExt_sendMessage(
	OV_INSTPTR_MessageSys_MsgSendExtension pobj,
	OV_INSTPTR_MessageSys_Message pMsg,
	OV_STRING headerString
	) {
    OV_INSTPTR_kshttp_httpclienthandler pClientHandler = NULL;
    OV_INSTPTR_kshttpMsgExt_MsgSendExt	this = Ov_StaticPtrCast(kshttpMsgExt_MsgSendExt, pobj);
    OV_INSTPTR_ksbase_Channel			pChannel	=	NULL;
    OV_RESULT result;

    result = ov_path_getObjectById(this->v_httpClientHandlerIDh, this->v_httpClientHandlerIDl, (OV_INSTPTR_ov_object*) &pClientHandler);
    if(Ov_Fail(result)){
    	Ov_DeleteObject(pMsg);
    	Ov_DeleteObject(pobj);
    	return result;
    }
    pChannel = Ov_DynamicPtrCast(ksbase_Channel, Ov_GetChild(MessageSys_Message2Channel, pMsg));
    if(!pChannel){
    	Ov_DeleteObject(pMsg);
    	Ov_DeleteObject(pobj);
    	return OV_ERR_GENERIC;
    }
    result = ov_string_print(&pClientHandler->v_ServerResponse.contentString, "<msg>%s%s</msg>", headerString, pMsg->v_msgBody);
    if(Ov_Fail(result)){
    	ov_logfile_error("%s: could not create message String: %s", this->v_identifier, ov_result_getresulttext(result));
    	Ov_DeleteObject(pMsg);
    	Ov_DeleteObject(pobj);
    	return result;
    }
    result = ov_string_setvalue(&pClientHandler->v_ServerResponse.contentType, "application/xml");
    if(Ov_Fail(result)){
    	ov_logfile_error("%s: could not set contentType: %s", this->v_identifier, ov_result_getresulttext(result));
    	Ov_DeleteObject(pMsg);
    	Ov_DeleteObject(pobj);
    	return result;
    }
    pClientHandler->v_ServerResponse.keepAlive = FALSE;
    result = kshttp_httpclienthandler_generateHttpHeader(pClientHandler->v_ClientRequest, &(pClientHandler->v_ServerResponse), &(pClientHandler->v_CommunicationStatus), result, NULL);
    if(Ov_Fail(result)){
    	Ov_DeleteObject(pMsg);
    	Ov_DeleteObject(pobj);
    	return result;
    }
    result = kshttp_httpclienthandler_sendHttpHeader(pClientHandler->v_ClientRequest, &(pClientHandler->v_ServerResponse), &(pClientHandler->v_CommunicationStatus), pChannel);
    if(Ov_Fail(result)){
    	Ov_DeleteObject(pMsg);
    	Ov_DeleteObject(pobj);
    	return result;
    }
    result = kshttp_httpclienthandler_sendHttpBody(pClientHandler->v_ClientRequest, &(pClientHandler->v_ServerResponse), &(pClientHandler->v_CommunicationStatus), pChannel);
    Ov_DeleteObject(pMsg);
    Ov_DeleteObject(pobj);
    return result;
}

OV_DLLFNCEXPORT OV_RESULT kshttpMsgExt_MsgSendExt_HandleData(
	OV_INSTPTR_ksbase_DataHandler this,
	OV_INSTPTR_ksbase_Channel pChannel,
	KS_DATAPACKET* dataReceived,
	KS_DATAPACKET* answer
) {
    KS_logfile_error(("%s: received data while waiting for message to send back --> weird things happened on the line. deleting connection.", this->v_identifier));
    ksbase_free_KSDATAPACKET(dataReceived);
    Ov_DeleteObject(this);
    return OV_ERR_BADVALUE;
}
