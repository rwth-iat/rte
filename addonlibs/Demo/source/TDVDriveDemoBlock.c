
/******************************************************************************
*
*   FILE
*   ----
*   TDVDriveDemoBlock.c
*
*   History
*   -------
*   2017-10-18   File created
*
*******************************************************************************
*
*   This file is generated by the 'acplt_builder' command
*
******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_Demo
#define OV_COMPILE_LIBRARY_Demo
#endif


#include "Demo.h"
#include "libov/ov_macros.h"
#include "lifeCycleEntry.h"


OV_DLLFNCEXPORT OV_ACCESS Demo_TDVDriveDemoBlock_getaccess(
	OV_INSTPTR_ov_object	pobj,
	const OV_ELEMENT		*pelem,
	const OV_TICKET			*pticket
) {
    /*    
    *   local variables
    */
	return (OV_ACCESS)OV_AC_WRITE | OV_AC_READ | OV_AC_LINKABLE | OV_AC_UNLINKABLE | OV_AC_DELETEABLE | OV_AC_RENAMEABLE;
}

OV_DLLFNCEXPORT void Demo_TDVDriveDemoBlock_typemethod(
	OV_INSTPTR_fb_functionblock	pfb,
	OV_TIME						*pltc
) {
    /*    
    *   local variables
    */
    OV_INSTPTR_Demo_TDVDriveDemoBlock pinst = Ov_StaticPtrCast(Demo_TDVDriveDemoBlock, pfb);

    // Set PVS actual State
    IdentificationType empty;
    IdentificationType_init(&empty);

    IdentificationType pvsId;
	IdentificationType_init(&pvsId);
	ov_string_setvalue(&pvsId.IdSpec, pinst->v_PVSStatePath);
	pvsId.IdType = 0;
	OV_ANY tmpAny;
	tmpAny.value.vartype = OV_VT_STRING;
	tmpAny.value.valueunion.val_string = NULL;
    if (pinst->v_ActualMotorValue > 0){
    	ov_string_setvalue(&tmpAny.value.valueunion.val_string, "Motor Running");
    }else{
    	ov_string_setvalue(&tmpAny.value.valueunion.val_string, "Motor Stopped");
    }
    propertyValueStatement_modelmanager_setPVS(pvsId, 0x80, NULL, empty, 0, 0, empty, 0, 0, tmpAny);
    Ov_SetAnyValue(&tmpAny, NULL);
    IdentificationType_deleteMembers(&pvsId);

    // Set PVS actual value
    IdentificationType pvsId2;
	IdentificationType_init(&pvsId2);
	ov_string_setvalue(&pvsId2.IdSpec, pinst->v_PVSActualValuePath);
	pvsId2.IdType = 0;
	OV_ANY tmpAny2;
	tmpAny2.value.vartype = OV_VT_SINGLE;
	tmpAny2.value.valueunion.val_single = pinst->v_ActualMotorValue;
	propertyValueStatement_modelmanager_setPVS(pvsId2, 0x80, NULL, empty, 0, 0, empty, 0, 0, tmpAny2);
	Ov_SetAnyValue(&tmpAny2, NULL);
	IdentificationType_deleteMembers(&pvsId2);
	IdentificationType_deleteMembers(&empty);

    switch (pinst->v_State){
    case 0: // Waiting for pressing the button
    	if (pinst->v_ButtonPressed == TRUE){
    		// CreateLCE, SetValueForMotor

    		// Search for LCESubModel
    		OV_INSTPTR_subModelLifeCycleEntry_SubModelLifeCycleEntry pSubModel = NULL;
    		pSubModel = Ov_DynamicPtrCast(subModelLifeCycleEntry_SubModelLifeCycleEntry, ov_path_getobjectpointer(pinst->v_LCESubModelPath, 2));
			if (!pSubModel){
				pinst->v_State = 4;
				return;
			}

			// Create LCE
			LifeCycleEntry lce;
			LifeCycleEntry_init(&lce);

			ov_string_setvalue(&lce.creatingInstance.IdSpec, pinst->v_LCECreatingInstanceIdString);
			lce.creatingInstance.IdType = pinst->v_LCECreatingInstanceIdType;

			ov_string_setvalue(&lce.writingInstance.IdSpec, pinst->v_LCEWritingInstanceIdString);
			lce.writingInstance.IdType = pinst->v_LCEWritingInstanceIdType;

			ov_string_setvalue(&lce.subject, pinst->v_LCESubject);

			ov_string_setvalue(&lce.eventClass, pinst->v_LCEEventClass);

			ov_string_setvalue(&lce.data.value.valueunion.val_string, "Motor started");
			lce.data.value.vartype = OV_VT_STRING;
			ov_time_gettime(&lce.data.time);

			lifeCycleEntry_LifeCycleArchive_createLCE(&pSubModel->p_LifeCycleArchiv, lce);
			LifeCycleEntry_deleteMembers(&lce);

			// Set Value for Motor
			pinst->v_ValueForMotorRamp = 1;
			pinst->v_State = 1;
    	}
    	break;
    case 1: // Waiting for Button released
    	if (pinst->v_ButtonPressed == FALSE)
    		pinst->v_State = 2;
    	break;
    case 2: // Waiting for Button pressed again
    	if (pinst->v_ButtonPressed == TRUE){
    		// CreateLCE, SetValueForMotor

    		// Search for LCESubModel
			OV_INSTPTR_subModelLifeCycleEntry_SubModelLifeCycleEntry pSubModel= Ov_DynamicPtrCast(subModelLifeCycleEntry_SubModelLifeCycleEntry, ov_path_getobjectpointer(pinst->v_LCESubModelPath, 2));
			if (!pSubModel){
				pinst->v_State = 4;
				return;
			}

			// Create LCE
			LifeCycleEntry lce;
			LifeCycleEntry_init(&lce);

			ov_string_setvalue(&lce.creatingInstance.IdSpec, pinst->v_LCECreatingInstanceIdString);
			lce.creatingInstance.IdType = pinst->v_LCECreatingInstanceIdType;

			ov_string_setvalue(&lce.writingInstance.IdSpec, pinst->v_LCEWritingInstanceIdString);
			lce.writingInstance.IdType = pinst->v_LCEWritingInstanceIdType;

			ov_string_setvalue(&lce.subject, pinst->v_LCESubject);

			ov_string_setvalue(&lce.eventClass, pinst->v_LCEEventClass);

			ov_string_setvalue(&lce.data.value.valueunion.val_string, "Motor stopped");
			lce.data.value.vartype = OV_VT_STRING;
			ov_time_gettime(&lce.data.time);

			lifeCycleEntry_LifeCycleArchive_createLCE(&pSubModel->p_LifeCycleArchiv, lce);
			LifeCycleEntry_deleteMembers(&lce);

			// Set Value for Motor
			pinst->v_ValueForMotorRamp = -1;
			pinst->v_State = 3;
    	}
		break;
    case 3: // Waiting for Button released
		if (pinst->v_ButtonPressed == FALSE)
			pinst->v_State = 0;
		break;
    case 4: // Error
    	if (pinst->v_Reset == TRUE){
    		pinst->v_Reset = FALSE;
    		pinst->v_ValueForMotorRamp = 0;
    		pinst->v_State = 0;
    	}
    	break;
    }
    return;
}

OV_DLLFNCEXPORT OV_RESULT Demo_TDVDriveDemoBlock_constructor(
	OV_INSTPTR_ov_object 	pobj
) {
    /*    
    *   local variables
    */
    OV_RESULT    result;

    /* do what the base class does first */
    result = fb_functionblock_constructor(pobj);
    if(Ov_Fail(result))
         return result;

    /* do what */

    return OV_ERR_OK;
}

