
/******************************************************************************
*
*   FILE
*   ----
*   msgCreator.c
*
*   History
*   -------
*   2013-06-11   File created
*
*******************************************************************************
*
*   This file is generated by the 'acplt_builder' command
*
******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_PCMsgCreator
#define OV_COMPILE_LIBRARY_PCMsgCreator
#endif


#include "PCMsgCreator.h"
#include "libov/ov_macros.h"
#include "libov/ov_vendortree.h"
#include "libov/ov_path.h"

static OV_UINT currID = 236492743;	/*	msdID will be incremented on every send	*/

static const char msgBody1 [] = "<msg><hdr><rcvSysAdr>";
static const char msgBody2 [] = "<rcvSysAdr/><rcvLocAdr>";
static const char msgBody3 [] = "</rcvLocAdr><msgId>";
static const char msgBody4 [] = "</msgId></hdr><bdy><val id=\"svc\">ProcessControl</val><val id=\"op\">";
static const char msgBody5 [] = "</val><sd><val id=\"cmdr\">";
static const char msgBody6 [] = "</val><val id=\"value\">";
static const char msgBody7 [] = "</val></sd></bdy></msg>";

OV_DLLFNCEXPORT OV_RESULT PCMsgCreator_msgCreator_order_set(
    OV_INSTPTR_PCMsgCreator_msgCreator          pobj,
    const OV_STRING  value
) {
    OV_RESULT result;
    OV_STRING msgBody = NULL;
    OV_STRING msgIdentifier = NULL;
    OV_STRING msgPrefix = "Message";
    OV_UINT i;
    OV_UINT tempctr = 0;
    OV_INSTPTR_MessageSys_Message pMsg = NULL;
    OV_ANY tempAny;
    OV_STRING command = NULL;
    OV_STRING commander = NULL;
    OV_STRING cmdValue = NULL;

    tempAny.value.vartype = OV_VT_VOID;
    tempAny.value.valueunion.val_double = 0.0;

	if(!value || !*value)
		return OV_ERR_BADPARAM;

    if(pobj->v_msgsInQueue >= pobj->v_queueLength)
    	return OV_ERR_NOACCESS;

    for(i=0; value[i]!='\0'; i++)
    {
    	if(value[i] == ';')
    		tempctr++;
    }
    if(tempctr!=2)
    	return OV_ERR_BADVALUE;	/*	an order has exactly 2 ";" in it	*/

    if(!pobj->v_receiverName || !pobj->v_receiverHost || !pobj->v_receiverInstance)
    	return OV_ERR_BADVALUE;

    ov_memstack_lock();

    msgIdentifier = ov_memstack_alloc(sizeof(msgPrefix) + 12);
    if(!msgIdentifier)
    	return OV_ERR_HEAPOUTOFMEMORY;

    snprintf(msgIdentifier, sizeof(msgPrefix) + 11, "%s%lu", msgPrefix, pobj->v_msgsInQueue);
    result = Ov_CreateObject(MessageSys_Message, pMsg, pobj, msgIdentifier);
    if(Ov_Fail(result))
    {
    	ov_memstack_unlock();
    	return result;
    }

    result = MessageSys_Message_senderAddress_set(pMsg, "none");
    if(Ov_Fail(result))
    {
    	Ov_DeleteObject(pMsg);
    	ov_memstack_unlock();
    	return result;
    }
    ov_vendortree_getservername(&tempAny, NULL);
    result = MessageSys_Message_senderName_set(pMsg, tempAny.value.valueunion.val_string);
    if(Ov_Fail(result))
    {
    	Ov_DeleteObject(pMsg);
    	ov_memstack_unlock();
    	return result;
    }
    result = MessageSys_Message_senderComponent_set(pMsg, ov_path_getcanonicalpath(Ov_StaticPtrCast(ov_object, pobj), 2));
    if(Ov_Fail(result))
    {
    	Ov_DeleteObject(pMsg);
    	ov_memstack_unlock();
    	return result;
    }

    result = MessageSys_Message_receiverName_set(pMsg, pobj->v_receiverName);
    if(Ov_Fail(result))
    {
    	Ov_DeleteObject(pMsg);
    	ov_memstack_unlock();
    	return result;
    }
    result = MessageSys_Message_receiverAddress_set(pMsg, pobj->v_receiverHost);
    if(Ov_Fail(result))
    {
    	Ov_DeleteObject(pMsg);
    	ov_memstack_unlock();
    	return result;
    }
    result = MessageSys_Message_receiverComponent_set(pMsg, pobj->v_receiverInstance);
    if(Ov_Fail(result))
    {
    	Ov_DeleteObject(pMsg);
    	ov_memstack_unlock();
    	return result;
    }

    MessageSys_Message_msgID_set(pMsg, currID);

    /*	generic party set, now build the body	*/

    commander = value;
    command = strchr(value, ';')+1;
    *(command-1) = '\0';
    cmdValue = strchr(command, ';')+1;
    *(cmdValue-1) = '\0';

    /*	reserve space	*/
    tempctr = (sizeof(msgBody1) + strlen(pobj->v_receiverHost)
			+ sizeof(msgBody2) + strlen(pobj->v_receiverName) + strlen(pobj->v_receiverInstance)
			+ sizeof(msgBody3) + 12
			+ sizeof(msgBody4) + strlen(command)
			+ sizeof(msgBody5) + strlen(commander)
			+ sizeof(msgBody6) + strlen(cmdValue)
			+ sizeof(msgBody7));
    msgBody = ov_memstack_alloc(tempctr + 1);

/*    ov_logfile_debug("lengths:\n%lu\n%lu\n%lu\n%lu\n%lu\n%lu\n%lu\n%lu\n%lu\n%lu\n%lu\n%lu\n%lu\n%lu",
    		sizeof(msgBody1), strlen(pobj->v_receiverHost), sizeof(msgBody2), strlen(pobj->v_receiverName), strlen(pobj->v_receiverInstance),
    		sizeof(msgBody3), 12, sizeof(msgBody4), strlen(command), sizeof(msgBody5), strlen(commander), sizeof(msgBody6), strlen(cmdValue),
    		sizeof(msgBody7));
*/
    if(!msgBody)
    {
    	Ov_DeleteObject(pMsg);
    	ov_memstack_unlock();
    	return OV_ERR_HEAPOUTOFMEMORY;
    }

    snprintf(msgBody, tempctr, "%s%s%s%s%s%s%lu%s%s%s%s%s%s%s", msgBody1, pobj->v_receiverHost,
    			msgBody2, pobj->v_receiverName, pobj->v_receiverInstance,
    			msgBody3, currID,
    			msgBody4, command,
    			msgBody5, commander,
    			msgBody6, cmdValue,
    			msgBody7);
 /*   ov_logfile_debug("length: %lu\nmessageBody:\n%s\n", tempctr, msgBody);	*/

    result = MessageSys_Message_msgBody_set(pMsg, msgBody);
    if(Ov_Fail(result))
    {
    	Ov_DeleteObject(pMsg);
    	ov_memstack_unlock();
    	return result;
    }

    currID++;
    ov_memstack_unlock();

	return OV_ERR_OK;
}

OV_DLLFNCEXPORT void PCMsgCreator_msgCreator_typemethod(
	OV_INSTPTR_fb_functionblock	pfb,
	OV_TIME						*pltc
) {
    /*    
    *   local variables
    */
    OV_INSTPTR_PCMsgCreator_msgCreator pinst = Ov_StaticPtrCast(PCMsgCreator_msgCreator, pfb);
    OV_INSTPTR_MessageSys_Message pMsg = NULL;
    OV_INSTPTR_MessageSys_MsgDelivery pMsgDelivery = NULL;


    Ov_ForEachChildEx(ov_containment, pinst, pMsg, MessageSys_Message)
    {
    	break;
    }

    if(pMsg)
    {
    	pMsgDelivery = Ov_GetParent(MessageSys_MsgDelivery2Message, pMsg);
    	if(pMsgDelivery)
    	{	/*	this message was already tried to be send	*/
    		pinst->v_tries++;
    		if(pinst->v_tries > 3)
    		{
    			Ov_DeleteObject(pMsg);
    			Ov_ForEachChildEx(ov_containment, pinst, pMsg, MessageSys_Message)
    			{
    				break;
    			}
    			if(pMsg)
    			{
    				Ov_Link(MessageSys_MsgDelivery2Message, pMsgDelivery, pMsg);
    				pinst->v_tries = 0;
    			}
    		}
    	}
    	else
    	{
    		pMsgDelivery = Ov_StaticPtrCast(MessageSys_MsgDelivery, Ov_GetFirstChild(ov_instantiation, pclass_MessageSys_MsgDelivery));
    		if(pMsgDelivery)
    		{
    			Ov_Link(MessageSys_MsgDelivery2Message, pMsgDelivery, pMsg);
    			pinst->v_tries = 0;
    		}
    	}
    }

    return;
}

