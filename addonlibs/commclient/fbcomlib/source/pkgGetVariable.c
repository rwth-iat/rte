
/******************************************************************************
 *
 *   FILE
 *   ----
 *   pkgGetVariable.c
 *
 *   History
 *   -------
 *   2013-05-18   File created
 *
 *******************************************************************************
 *
 *   This file is generated by the 'acplt_builder' command
 *
 ******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_fbcomlib
#define OV_COMPILE_LIBRARY_fbcomlib
#endif


#include "fbcomlib.h"
#include "libov/ov_macros.h"
#include "config.h"
#include "ksapi_commonFuncs.h"


OV_DLLFNCEXPORT OV_RESULT fbcomlib_pkgGetVariable_constructor(
		OV_INSTPTR_ov_object 	pobj
) {
	/*
	 *   local variables
	 */
	OV_INSTPTR_fbcomlib_pkgGetVariable pinst = Ov_StaticPtrCast(fbcomlib_pkgGetVariable, pobj);
	OV_RESULT    result;

	/* do what the base class does first */
	result = fb_functionblock_constructor(pobj);
	if(Ov_Fail(result))
		return result;

	/* do what */
	pinst->v_actimode = 1;
	pinst->v_iexreq = 1;

	return OV_ERR_OK;
}

OV_DLLFNCEXPORT void fbcomlib_pkgGetVariable_typemethod(
		OV_INSTPTR_fb_functionblock	pfb,
		OV_TIME						*pltc
) {
	/*
	 *   local variables
	 */
	OV_INSTPTR_fbcomlib_pkgGetVariable pinst = Ov_StaticPtrCast(fbcomlib_pkgGetVariable, pfb);
	OV_INSTPTR_fbcomlib_getVar	pGetVar = Ov_StaticPtrCast(fbcomlib_getVar, Ov_GetParent(fbcomlib_PkgVar, pinst));
	OV_RESULT result;

	if(pGetVar)
	{	/*	we are connected to a parent getVar	*/
		if((pGetVar->v_state == FBCOMLIB_STATE_OK) ||(pGetVar->v_state == FBCOMLIB_STATE_INIT)||(pGetVar->v_state == FBCOMLIB_STATE_WAITING))
		{
			if((pGetVar->p_apiGet.v_status == KSAPI_COMMON_REQUESTCOMPLETED) || (pGetVar->p_apiGet.v_status == KSAPI_COMMON_WAITINGFORANSWER))
			{	/*	ksapi-request completed --> get answer	*/
				pinst->v_varResult = pinst->p_apiVar.v_varRes;
				if(Ov_OK(pinst->v_varResult))
						if(Ov_Fail(Ov_SetAnyValue(&(pinst->v_value), &(pinst->p_apiVar.v_varValue))))
							fbcomlib_FBComCommon_state_set(Ov_StaticPtrCast(fbcomlib_FBComCommon, pGetVar), FBCOMLIB_STATE_INTERNAL_ERROR);
				return;
			}

			if((pGetVar->v_state == FBCOMLIB_STATE_OK) ||(pGetVar->v_state == FBCOMLIB_STATE_INIT))
			{	/*	ready to start	*/
				/*	ksapi-object found	*/
				if(!pGetVar->v_doCyclic)
				{	/*	single send requested	*/
					result = ov_string_setvalue(&(pinst->p_apiVar.v_path), pinst->v_path);
					if(Ov_Fail(result))
					{
						pGetVar->v_errorCode = result;
						fbcomlib_FBComCommon_state_set(Ov_StaticPtrCast(fbcomlib_FBComCommon, pGetVar), FBCOMLIB_STATE_INTERNAL_ERROR);
						return;
					}
				}
				return;
			}
		}
	}
	return;
}

