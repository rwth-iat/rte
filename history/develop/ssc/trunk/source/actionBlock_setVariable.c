/*
*   The Framework was generated by the ACPLT/OV Builder.
*
*   Builder version: 1.0.4
*   Date of file generation:  15-Jul-2011 (13:34:12)
*/

#ifndef OV_COMPILE_LIBRARY_ssc
#define OV_COMPILE_LIBRARY_ssc
#endif

#include "ov.h"
#include "ssc.h"
#include "ssclib.h"

#include "libov/ov_macros.h"
#include "libov/ov_path.h"


OV_DLLFNCEXPORT OV_RESULT ssc_setVariable_variable_set(
    OV_INSTPTR_ssc_setVariable          pinst,
    const OV_STRING  value
) {
    // check input
    if (ov_string_compare(value, NULL)==0)
    {
    	pinst->v_error=TRUE;
       	ov_string_setvalue(&pinst->v_errorDetail, "variable is not defined.");
       	return OV_ERR_OK;
    };

    pinst->v_error=FALSE;
    ov_string_setvalue(&pinst->v_errorDetail, NULL);

    return ov_string_setvalue(&pinst->v_variable,value);
}

OV_DLLFNCEXPORT OV_RESULT ssc_setVariable_value_set(
    OV_INSTPTR_ssc_setVariable          pobj,
    const OV_ANY*  value
) {
    return ov_variable_setanyvalue(&pobj->v_value, value);
}

OV_DLLFNCEXPORT void ssc_setVariable_typemethod(
	OV_INSTPTR_fb_functionblock	pfb,
	OV_TIME						*pltc
) {
    // local variables
    OV_INSTPTR_ssc_setVariable pinst = Ov_StaticPtrCast(ssc_setVariable, pfb);
    OV_INSTPTR_ssc_step  pStep= Ov_DynamicPtrCast(ssc_step, Ov_GetParent(ov_containment, pinst));
    OV_INSTPTR_ssc_sscHeader  pSSC= Ov_DynamicPtrCast(ssc_sscHeader, Ov_GetParent(ov_containment, pStep));
    OV_RESULT    result;
    OV_UINT stringCount;
    OV_STRING* pathToVariable;
    OV_INSTPTR_ov_object pObj = NULL;
    OV_ELEMENT element;
    OV_ELEMENT varElement;
    OV_VTBLPTR_ov_object pVtblObj = NULL;


    // init variables
    pinst->v_cyctime.secs = 0;
    pinst->v_cyctime.usecs = 0;
    pinst->v_iexreq = 1;
    pinst->v_error=FALSE;

    ov_string_setvalue(&pinst->v_errorDetail, NULL);

    // check location
    if ( pStep==NULL )
	{
    	pinst->v_error=TRUE;
		ov_logfile_error("ssc_actionBlock_constructor: action block must be encapsulated in a step.");
		return;
	}

    // check input
    if (ov_string_compare(pinst->v_variable, NULL)==0)
    {
    	pinst->v_error=TRUE;
       	ov_string_setvalue(&pinst->v_errorDetail, "variable is not defined.");
    };


    // set variable
    //result= fb_functionchart_getvariable(Ov_PtrUpCast(fb_functionchart, pSSC), pinst->v_variable, &pinst->v_value);
    //result= fb_functionchart_setvariable(Ov_PtrUpCast(fb_functionchart, pSSC), pinst->v_variable, &pinst->v_value);


// Extension to set any Port at any Variable
    //split the input at dot
    pathToVariable =  ov_string_split(pinst->v_variable,".", &stringCount);
    pObj = ov_path_getobjectpointer(pathToVariable[0],2);

    if(pObj != NULL && pathToVariable != NULL)
    {
    	if (Ov_CanCastTo(fb_functionblock,pObj))
    	{
    		//set variable in a functionchart

    		result = fb_functionchart_setport((OV_INSTPTR_fb_functionchart)pObj, pathToVariable[1], &(pinst->v_value));
    	}
    	else
    	{
    		//set variable in a functionblock
			varElement.elemtype = OV_ET_NONE;
			element.elemtype = OV_ET_OBJECT;
			element.pobj = pObj;
			//iterate over all ports of the object to find the destination port for the set operation
			ov_element_getnextpart(&element, &varElement, OV_ET_VARIABLE);

			while(varElement.elemtype != OV_ET_NONE)
			{
				if(varElement.elemunion.pvar)
				{
					if(ov_string_compare(varElement.elemunion.pvar->v_identifier, pathToVariable[1]) == OV_STRCMP_EQUAL)	/*	variable name matches	*/
					{
						//port found, use the setter to write the value
						Ov_GetVTablePtr(ov_object, pVtblObj, pObj);
						result = pVtblObj->m_setvar(varElement.pobj, &varElement, &(pinst->v_value));

					}
				}
				ov_element_getnextpart(&element, &varElement, OV_ET_VARIABLE);
			}
    	}
    }
    else
    {
    	pinst->v_error = TRUE;
    	ov_string_setvalue(&pinst->v_errorDetail, "path not found");
    }

    //result = fb_functionchart_setport( Ov_DynamicPtrCast(fb_functionchart, Ov_GetParent(ov_containment, pSSC)), pinst->v_variable, &pinst->v_value);

    if(Ov_Fail(result))
    {
    	pinst->v_error=TRUE;
    	ov_string_setvalue(&pinst->v_errorDetail, "bad parameter");

    }

/*
    		OV_INSTPTR_fb_functionchart pfc,
    		 const OV_STRING varname,
    		 OV_ANY *pvarcurrprops)
*/

    return;
}

OV_DLLFNCEXPORT OV_RESULT ssc_setVariable_setActionName(
             OV_INSTPTR_ssc_actionBlock          pinst,
             const OV_STRING  value
) {
	return ov_string_setvalue(&pinst->v_actionName,value);
}
