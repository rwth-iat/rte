
/******************************************************************************
*
*   FILE
*   ----
*   variable.c
*
*   History
*   -------
*   2011-06-10   File created
*
*******************************************************************************
*
*   This file is generated by the 'fb_builder' command
*
******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_fb
#define OV_COMPILE_LIBRARY_fb
#endif


#include "fb.h"
#include "libov/ov_macros.h"

int 
fb_vartype_implemented
(OV_VAR_TYPE typ);

OV_RESULT
fb_varvalue_changed
(const OV_ELEMENT *pelem, const OV_ANY *pvarcurrprops, OV_BOOL *changed);


OV_DLLFNCEXPORT OV_UINT fb_variable_flags_get(
    OV_INSTPTR_fb_variable          pobj
) {
    return pobj->v_flags;
}

OV_DLLFNCEXPORT OV_RESULT fb_variable_flags_set(
    OV_INSTPTR_fb_variable          pobj,
    const OV_UINT  value
) {
    pobj->v_flags = value;
    return OV_ERR_OK;
}

OV_DLLFNCEXPORT OV_STRING fb_variable_unit_get(
    OV_INSTPTR_fb_variable          pobj
) {
    return pobj->v_unit;
}

OV_DLLFNCEXPORT OV_RESULT fb_variable_unit_set(
    OV_INSTPTR_fb_variable          pobj,
    const OV_STRING  value
) {
    return ov_string_setvalue(&pobj->v_unit,value);
}

OV_DLLFNCEXPORT OV_STRING fb_variable_comment_get(
    OV_INSTPTR_fb_variable          pobj
) {
    return pobj->v_comment;
}

OV_DLLFNCEXPORT OV_RESULT fb_variable_comment_set(
    OV_INSTPTR_fb_variable          pobj,
    const OV_STRING  value
) {
    return ov_string_setvalue(&pobj->v_comment,value);
}

OV_DLLFNCEXPORT OV_RESULT
fb_variable_getvar
(OV_INSTPTR_ov_object pobj,
 const OV_ELEMENT * pelem,
 OV_ANY * pvarcurrprops)
{
  return ov_object_getvar (pobj, pelem, pvarcurrprops);
}

OV_DLLFNCEXPORT OV_RESULT 
fb_variable_setvar
(OV_INSTPTR_ov_object pobj,
 const OV_ELEMENT * pelem,
 const OV_ANY * pvarcurrprops)
{
  OV_RESULT result;
  OV_BOOL runSetVar;
  OV_INSTPTR_fb_functionchart pfc;
  OV_INSTPTR_fb_variable pinst = Ov_StaticPtrCast (fb_variable, pobj);
 
  if (pelem->elemtype == OV_ET_VARIABLE)
  {

    /* Check the variable type */
    if ( !fb_vartype_implemented (pelem->elemunion.pvar->v_vartype))
    {
      return OV_ERR_BADTYPE;
    }

    /* ANY? Passt alles rein */
    if ((pelem->elemunion.pvar->v_vartype & OV_VT_KSMASK) != OV_VT_ANY)
    {
      /* Sonnst nur vom gleichen Typ */
      if ((pvarcurrprops->value.vartype & OV_VT_KSMASK)
          != (pelem->elemunion.pvar->v_vartype & OV_VT_KSMASK))
      {
        return OV_ERR_BADTYPE;
      }
    }

    /* SetVar accessor? */
    if (pelem->elemunion.pvar->v_setfnc)
    {
      runSetVar = TRUE;
    } 
    else
    {
      /* Compare values */
      result = fb_varvalue_changed (pelem, pvarcurrprops, &runSetVar);
      if (result != OV_ERR_OK)
      {
        return result;
      }
    }
    if (runSetVar)
    {
      pfc = Ov_GetParent (fb_variables, pinst);
      if (pfc) pfc->v_eexreq = TRUE;
      return ov_object_setvar (pobj, pelem, pvarcurrprops);
    }
    return OV_ERR_OK;
  }
  else return OV_ERR_BADPARAM;
}
