
/******************************************************************************
*
*   FILE
*   ----
*   downloadApplication.c
*
*   History
*   -------
*   2013-04-29   File created
*
*******************************************************************************
*
*   This file is generated by the 'acplt_builder' command
*
******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_cshmi
#define OV_COMPILE_LIBRARY_cshmi
#endif

#include "cshmi.h"
#include "cshmilib.h"

/**
 * afz%22
 * Gka%7B
 * Gkz%7D
 * Eka%5B
 * Ekz%5D
 * Rka(
 * Rkz)
 * plus+
 */

/**
 * returns a list of ov_containment
 * embedment/OV_PART is known to the visualisation system
 * @param pObj
 * @param strResult Pointer to the result String
 * @param isFirstEntry if FALSE the function adds an "," as a separator
 * @return
 */
OV_BOOL cshmi_downloadApplication_buildChildList(OV_INSTPTR_ov_object pObj, OV_STRING*strResult, OV_BOOL isFirstEntry){
	OV_INSTPTR_ov_object pChildObj = NULL;
	OV_INSTPTR_cshmi_IfThenElse pIfThenElse = NULL;
	OV_INSTPTR_cshmi_ChildrenIterator pChildrenIterator = NULL;

	if(!Ov_CanCastTo(ov_domain, pObj)){
		return OV_ERR_OK;
	}
	if(isFirstEntry == FALSE){
		ov_string_append(strResult, ",");
	}

	ov_string_append(strResult, "%22");
	ov_memstack_lock();
	ov_string_append(strResult, ov_path_getcanonicalpath(pObj, 2));
	ov_memstack_unlock();
	ov_string_append(strResult, "%22:%7B");
	ov_string_append(strResult, "%22ChildListParameters%22:[");

	//iterate over all childrens and list them
	Ov_ForEachChild(ov_containment, Ov_StaticPtrCast(ov_domain, pObj), pChildObj){
		ov_string_append(strResult, "%22");
		ov_string_append(strResult, pChildObj->v_identifier);
		ov_string_append(strResult, " ");
		ov_memstack_lock();
		ov_string_append(strResult, ov_path_getcanonicalpath(Ov_PtrUpCast(ov_object, Ov_GetClassPtr(pChildObj)), 2));
		ov_memstack_unlock();
		ov_string_append(strResult, "%22");
		if(Ov_GetNextChild(ov_containment, pChildObj) != NULL){
			ov_string_append(strResult, ",");
		}
	};
	ov_string_append(strResult, "]%7D");

	//interesting ov_containment childrens are domains or cshmi objects
	if(		Ov_CanCastTo(cshmi_Object, pObj)
			|| Ov_GetParent(ov_instantiation, pObj)==pclass_ov_domain
			){
		Ov_ForEachChild(ov_containment, Ov_StaticPtrCast(ov_domain, pObj), pChildObj){
			cshmi_downloadApplication_buildChildList(pChildObj, strResult, FALSE);
		}
	}
	//some ov_embedment childrens
	if(Ov_CanCastTo(cshmi_IfThenElse, pObj)){
		pIfThenElse = Ov_StaticPtrCast(cshmi_IfThenElse, pObj);
		cshmi_downloadApplication_buildChildList(Ov_PtrUpCast(ov_object, &pIfThenElse->p_if), strResult, FALSE);
		cshmi_downloadApplication_buildChildList(Ov_PtrUpCast(ov_object, &pIfThenElse->p_then), strResult, FALSE);
		cshmi_downloadApplication_buildChildList(Ov_PtrUpCast(ov_object, &pIfThenElse->p_else), strResult, FALSE);
	}else if(Ov_CanCastTo(cshmi_ChildrenIterator, pObj)){
		pChildrenIterator = Ov_StaticPtrCast(cshmi_ChildrenIterator, pObj);
		cshmi_downloadApplication_buildChildList(Ov_PtrUpCast(ov_object, &pChildrenIterator->p_forEachChild), strResult, FALSE);
	}
	return OV_ERR_OK;
}

/**
 * prints the basic types to the string (visible, stroke, fill, opacity, rotate)
 * @param strResult
 * @param pElement
 * @return
 */
OV_BOOL cshmi_downloadApplication_buildBaseElementString(OV_STRING*strResult, OV_INSTPTR_cshmi_Element pElement){
	ov_string_print(strResult, "%s%%22visible%%22:%%22%s%%22,", *strResult, (pElement->v_visible==TRUE?"TRUE":"FALSE"));
	ov_string_print(strResult, "%s%%22stroke%%22:%%22%s%%22,", *strResult, pElement->v_stroke==NULL?"":pElement->v_stroke);
	ov_string_print(strResult, "%s%%22fill%%22:%%22%s%%22,", *strResult, pElement->v_fill==NULL?"":pElement->v_fill);
	ov_string_print(strResult, "%s%%22opacity%%22:%%22%f%%22,", *strResult, pElement->v_opacity);
	ov_string_print(strResult, "%s%%22rotate%%22:%%22%i%%22,", *strResult, pElement->v_rotate);
	return OV_ERR_OK;
}
OV_BOOL cshmi_downloadApplication_buildElementList(OV_STRING*strResult){
	OV_INSTPTR_ov_object pObj = NULL;
	OV_INSTPTR_cshmi_Template pTemplate = NULL;
	OV_INSTPTR_cshmi_Group pGroup = NULL;
	OV_INSTPTR_cshmi_TemplateDefinition pTemplateDefinition = NULL;
	OV_INSTPTR_cshmi_Rectangle pRectangle = NULL;
	OV_INSTPTR_cshmi_Circle pCircle = NULL;
	OV_INSTPTR_cshmi_Text pText = NULL;

	OV_STRING temp = NULL;
	OV_UINT i = 0;
	OV_BOOL elementInstantiated = FALSE;

	Ov_ForEachChild(ov_instantiation, pclass_cshmi_Group, pObj){
		elementInstantiated = TRUE;
		pGroup = Ov_StaticPtrCast(cshmi_Group, pObj);
		ov_string_append(strResult, "%22");
		ov_memstack_lock();
		ov_string_append(strResult, ov_path_getcanonicalpath(Ov_PtrUpCast(ov_object, pObj), 2));
		ov_memstack_unlock();
		ov_string_append(strResult, "%22:%7B");
		ov_string_append(strResult, "%22Parameters%22:%7B");
		ov_string_print(strResult, "%s%%22x%%22:%%22%f%%22,", *strResult, pGroup->v_x);
		ov_string_print(strResult, "%s%%22y%%22:%%22%f%%22,", *strResult, pGroup->v_y);
		ov_string_print(strResult, "%s%%22width%%22:%%22%f%%22,", *strResult, pGroup->v_width);
		ov_string_print(strResult, "%s%%22height%%22:%%22%f%%22,", *strResult, pGroup->v_height);
		ov_string_print(strResult, "%s%%22hideable%%22:%%22%s%%22,", *strResult, (pGroup->v_hideable==TRUE?"TRUE":"FALSE"));
		ov_string_print(strResult, "%s%%22visible%%22:%%22%s%%22", *strResult, (pGroup->v_visible==TRUE?"TRUE":"FALSE"));
		ov_string_append(strResult, "%7D");
		ov_string_append(strResult, "%7D");
		if(Ov_GetNextChild(ov_instantiation, pObj) != NULL){
			ov_string_append(strResult, ",");
		}
	}
	if(elementInstantiated == TRUE){
		ov_string_append(strResult, ",");
	}
	elementInstantiated = FALSE;
	Ov_ForEachChild(ov_instantiation, pclass_cshmi_TemplateDefinition, pObj){
		elementInstantiated = TRUE;
		pTemplateDefinition = Ov_StaticPtrCast(cshmi_TemplateDefinition, pObj);
		ov_string_append(strResult, "%22");
		ov_memstack_lock();
		ov_string_append(strResult, ov_path_getcanonicalpath(Ov_PtrUpCast(ov_object, pObj), 2));
		ov_memstack_unlock();
		ov_string_append(strResult, "%22:%7B");
		ov_string_append(strResult, "%22Parameters%22:%7B");
		ov_string_print(strResult, "%s%%22width%%22:%%22%f%%22,", *strResult, pTemplateDefinition->v_width);
		ov_string_print(strResult, "%s%%22height%%22:%%22%f%%22", *strResult, pTemplateDefinition->v_height);
		ov_string_append(strResult, "%7D");
		ov_string_append(strResult, "%7D");
		if(Ov_GetNextChild(ov_instantiation, pObj) != NULL){
			ov_string_append(strResult, ",");
		}
	}
	if(elementInstantiated == TRUE){
		ov_string_append(strResult, ",");
	}
	elementInstantiated = FALSE;
	Ov_ForEachChild(ov_instantiation, pclass_cshmi_Template, pObj){
		elementInstantiated = TRUE;
		pTemplate = Ov_StaticPtrCast(cshmi_Template, pObj);
		ov_string_append(strResult, "%22");
		ov_memstack_lock();
		ov_string_append(strResult, ov_path_getcanonicalpath(Ov_PtrUpCast(ov_object, pObj), 2));
		ov_memstack_unlock();
		ov_string_append(strResult, "%22:%7B");
		ov_string_append(strResult, "%22Parameters%22:%7B");
		cshmi_downloadApplication_buildBaseElementString(strResult, Ov_PtrUpCast(cshmi_Element, pTemplate));
		ov_string_print(strResult, "%s%%22TemplateDefinition%%22:%%22%s%%22,", *strResult, pTemplate->v_TemplateDefinition==NULL?"":pTemplate->v_TemplateDefinition);
		ov_string_print(strResult, "%s%%22x%%22:%%22%f%%22,", *strResult, pTemplate->v_x);
		ov_string_print(strResult, "%s%%22y%%22:%%22%f%%22,", *strResult, pTemplate->v_y);

		ov_string_print(strResult, "%s%%22FBReference%%22:%%22%s%%22,", *strResult, pTemplate->v_FBReference.veclen!=1?"":pTemplate->v_FBReference.value[0]);

		if(pTemplate->v_FBVariableReference.veclen == 0){
			ov_string_setvalue(&temp, "%22%22");
		}else if(pTemplate->v_FBVariableReference.veclen == 1){
			ov_string_print(&temp, "%%22%s%%22", pTemplate->v_FBVariableReference.value[0]);
		}else{
			ov_string_print(&temp, "%%22%s", pTemplate->v_FBVariableReference.value[0]);
			for(i = 1; i < pTemplate->v_FBVariableReference.veclen;i++){
				ov_string_print(&temp, "%s %s", temp, pTemplate->v_FBVariableReference.value[i]);
			}
			ov_string_append(&temp, "%22");
		}
		ov_string_print(strResult, "%s%%22FBVariableReference%%22:%s,", *strResult, temp);

		if(pTemplate->v_ConfigValues.veclen == 0){
			ov_string_setvalue(&temp, "%22%22");
		}else if(pTemplate->v_ConfigValues.veclen == 1){
			ov_string_print(&temp, "%%22%s%%22", pTemplate->v_ConfigValues.value[0]);
		}else{
			ov_string_print(&temp, "%%22%s", pTemplate->v_ConfigValues.value[0]);
			for(i = 1; i < pTemplate->v_ConfigValues.veclen;i++){
				ov_string_print(&temp, "%s %s", temp, pTemplate->v_ConfigValues.value[i]);
			}
			ov_string_append(&temp, "%22");
		}
		ov_string_print(strResult, "%s%%22ConfigValues%%22:%s,", *strResult, temp);

		ov_string_print(strResult, "%s%%22hideable%%22:%%22%s%%22", *strResult, (pTemplate->v_hideable==TRUE?"TRUE":"FALSE"));
		ov_string_append(strResult, "%7D");
		ov_string_append(strResult, "%7D");
		if(Ov_GetNextChild(ov_instantiation, pObj) != NULL){
			ov_string_append(strResult, ",");
		}
	};
	if(elementInstantiated == TRUE){
		ov_string_append(strResult, ",");
	}
	elementInstantiated = FALSE;
	Ov_ForEachChild(ov_instantiation, pclass_cshmi_Rectangle, pObj){
		elementInstantiated = TRUE;
		pRectangle = Ov_StaticPtrCast(cshmi_Rectangle, pObj);
		ov_string_append(strResult, "%22");
		ov_memstack_lock();
		ov_string_append(strResult, ov_path_getcanonicalpath(Ov_PtrUpCast(ov_object, pObj), 2));
		ov_memstack_unlock();
		ov_string_append(strResult, "%22:%7B");
		ov_string_append(strResult, "%22Parameters%22:%7B");
		cshmi_downloadApplication_buildBaseElementString(strResult, Ov_PtrUpCast(cshmi_Element, pRectangle));
		ov_string_print(strResult, "%s%%22x%%22:%%22%f%%22,", *strResult, pRectangle->v_x);
		ov_string_print(strResult, "%s%%22y%%22:%%22%f%%22,", *strResult, pRectangle->v_y);
		ov_string_print(strResult, "%s%%22width%%22:%%22%f%%22,", *strResult, pRectangle->v_width);
		ov_string_print(strResult, "%s%%22height%%22:%%22%f%%22,", *strResult, pRectangle->v_height);
		ov_string_print(strResult, "%s%%22strokeWidth%%22:%%22%f%%22", *strResult, pRectangle->v_strokeWidth);
		ov_string_append(strResult, "%7D");
		ov_string_append(strResult, "%7D");
		if(Ov_GetNextChild(ov_instantiation, pObj) != NULL){
			ov_string_append(strResult, ",");
		}
	}
	if(elementInstantiated == TRUE){
		ov_string_append(strResult, ",");
	}
	elementInstantiated = FALSE;
	Ov_ForEachChild(ov_instantiation, pclass_cshmi_Circle, pObj){
		elementInstantiated = TRUE;
		pCircle = Ov_StaticPtrCast(cshmi_Circle, pObj);
		ov_string_append(strResult, "%22");
		ov_memstack_lock();
		ov_string_append(strResult, ov_path_getcanonicalpath(Ov_PtrUpCast(ov_object, pObj), 2));
		ov_memstack_unlock();
		ov_string_append(strResult, "%22:%7B");
		ov_string_append(strResult, "%22Parameters%22:%7B");
		cshmi_downloadApplication_buildBaseElementString(strResult, Ov_PtrUpCast(cshmi_Element, pCircle));
		ov_string_print(strResult, "%s%%22cx%%22:%%22%f%%22,", *strResult, pCircle->v_cx);
		ov_string_print(strResult, "%s%%22cy%%22:%%22%f%%22,", *strResult, pCircle->v_cy);
		ov_string_print(strResult, "%s%%22r%%22:%%22%f%%22,", *strResult, pCircle->v_r);
		ov_string_print(strResult, "%s%%22strokeWidth%%22:%%22%f%%22", *strResult, pCircle->v_strokeWidth);
		ov_string_append(strResult, "%7D");
		ov_string_append(strResult, "%7D");
		if(Ov_GetNextChild(ov_instantiation, pObj) != NULL){
			ov_string_append(strResult, ",");
		}
	}
	if(elementInstantiated == TRUE){
		ov_string_append(strResult, ",");
	}
	elementInstantiated = FALSE;
	Ov_ForEachChild(ov_instantiation, pclass_cshmi_Text, pObj){
		elementInstantiated = TRUE;
		pText = Ov_StaticPtrCast(cshmi_Text, pObj);
		ov_string_append(strResult, "%22");
		ov_memstack_lock();
		ov_string_append(strResult, ov_path_getcanonicalpath(Ov_PtrUpCast(ov_object, pObj), 2));
		ov_memstack_unlock();
		ov_string_append(strResult, "%22:%7B");
		ov_string_append(strResult, "%22Parameters%22:%7B");
		cshmi_downloadApplication_buildBaseElementString(strResult, Ov_PtrUpCast(cshmi_Element, pText));
		ov_string_print(strResult, "%s%%22x%%22:%%22%f%%22,", *strResult, pText->v_x);
		ov_string_print(strResult, "%s%%22y%%22:%%22%f%%22,", *strResult, pText->v_y);
		ov_string_print(strResult, "%s%%22content%%22:%%22%s%%22,", *strResult, pText->v_content==NULL?"":pText->v_content);
		ov_string_print(strResult, "%s%%22fontSize%%22:%%22%s%%22,", *strResult, pText->v_fontSize==NULL?"":pText->v_fontSize);
		ov_string_print(strResult, "%s%%22fontStyle%%22:%%22%s%%22,", *strResult, pText->v_fontStyle==NULL?"":pText->v_fontStyle);
		ov_string_print(strResult, "%s%%22fontWeight%%22:%%22%s%%22,", *strResult, pText->v_fontWeight==NULL?"":pText->v_fontWeight);
		ov_string_print(strResult, "%s%%22fontFamily%%22:%%22%s%%22,", *strResult, pText->v_fontFamily==NULL?"":pText->v_fontFamily);
		ov_string_print(strResult, "%s%%22horAlignment%%22:%%22%s%%22,", *strResult, pText->v_horAlignment==NULL?"":pText->v_horAlignment);
		ov_string_print(strResult, "%s%%22verAlignment%%22:%%22%s%%22,", *strResult, pText->v_verAlignment==NULL?"":pText->v_verAlignment);
		ov_string_print(strResult, "%s%%22trimToLength%%22:%%22%i%%22", *strResult, pText->v_trimToLength);
		ov_string_append(strResult, "%7D");
		ov_string_append(strResult, "%7D");
		if(Ov_GetNextChild(ov_instantiation, pObj) != NULL){
			ov_string_append(strResult, ",");
		}
	}

	ov_string_setvalue(&temp, NULL);
	return OV_ERR_OK;
}

OV_DLLFNCEXPORT OV_STRING cshmi_downloadApplication_asJSON_get(
    OV_INSTPTR_cshmi_downloadApplication          pThis
) {
	OV_STRING returnString;
	OV_STRING strResult = NULL;
	OV_INSTPTR_ov_object pObj = NULL;

	pObj = ov_path_getobjectpointer("/TechUnits/cshmi", 2);
	if(pObj == NULL || !Ov_CanCastTo(ov_domain, pObj)){
		return (OV_STRING) 0;
	}

	//open JSON Element
	ov_string_setvalue(&strResult, "%7B");

	//Elements is a list of configured elements
	ov_string_append(&strResult, "%22Elements%22:%7B");
	cshmi_downloadApplication_buildElementList(&strResult);
	ov_string_append(&strResult, "%7D,");

	//ChildList is a list of ov_containment
	ov_string_append(&strResult, "%22ChildList%22:%7B");
	cshmi_downloadApplication_buildChildList(pObj, &strResult, TRUE);
	ov_string_append(&strResult, "%7D");

	//Actions is a list of actions, set/get stores the result only
	//Conditions saves all conditions

	//close JSON Element
	ov_string_append(&strResult, "%7D");

	returnString = (OV_STRING) ov_memstack_alloc(ov_path_percentsize(strResult));
	strcpy(returnString, strResult);
	ov_string_setvalue(&strResult, NULL);
	return returnString;


}

