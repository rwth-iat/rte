<!DOCTYPE html>
<html>
	<head>
		<meta charset="Windows-1252">
		<title>OV-http Server</title>
		<style type="text/css">
			code{
				background-color: #DDDDFF;
				border: 1px solid #8080FF;
				color: #000080;
			}
			#idPlaygroundOutput, #idUrldisplay{
				background-color: lightgrey;
				border: 1px solid #8080FF;
				color: #000080;
				width:500px;
				display:block;
			}
		</style>
	</head>
	<body>
		<h1>The Webserver is running!</h1>
		<p>Powered by ACPLT/OV. This server has some static files as a <a href="sse.html">demo</a> and supports KS commands. This page is only a quick reference.</p>
		<span id="idServices"></span>
		<div id="idCommandPlayground" style="display:none;">
			<h1>Command playground</h1>
			<div>
				<input type="button" id="idSubmitbutton" value="send request">
				<select id="idServicelist">
					<option value="none">select type of request</option>
					<option value="getEP">getEP</option>
					<option value="getVar">getVar</option>
					<option value="setVar">setVar</option>
				</select>
				path: 
				<input id="idPathInput" value="/TechUnits" placeholder="full path to the object/variable" style="width:200px;">
				<span id="idSecondtextSpan" style="display:none;">
					<span id="idSecondtextLabel">new value: </span>
					<input id="idSecondtextInput" placeholder="new value to set" style="width:200px;">
				</span>
				<span id="idSpanGetepRequestType" style="display:none;">
					request type: 
					<select id="idGetepRequestTypeSelect">
						<option value="OT_DOMAIN">children (OT_DOMAIN)</option>
						<option value="OT_VARIABLE">variables (OT_VARIABLE)</option>
						<option value="OT_LINK">associations (OT_LINK)</option>
						<option value="OT_ANY">all (OT_ANY)</option>
					</select>
				</span>
			</div>
			<input readonly id="idUrldisplay" value="Command will be displayed here">
			<textarea readonly id="idPlaygroundOutput">Reply will be displayed here</textarea>
		</div>
		<h1>Supported KS commands</h1>
		<p>This server can generate answers in a TCL or KSX syntax. The TCL syntax is default. 
		It is possible to select KSX with the 
		<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html">HTTP accept header</a>
		<code>Accept: text/ksx</code> or as a parameter in the GET request argument <code>&amp;format=tcl</code>.</p>
		<h2>GetVar</h2>
		<p>Gets one or multiple Variables.</p>
		example: <code>/getVar?format=ksx&amp;path=/vendor/database_free</code><br>
		example: <code>/getVar?format=ksx&amp;path[0]=/vendor/database_free&amp;path[1]=/vendor/database_size</code>
		<h2>SetVar</h2>
		<p>Sets one or multiple Variables.</p>
		example: <code>/setVar?format=ksx&amp;path=/TechUnits/add1.IN1&amp;newvalue=4.5</code><br>
		example: <code>/setVar?format=ksx&amp;path[0]=/TechUnits/add1.IN1&amp;path[1]=/TechUnits/add2.IN1&amp;path[2]=.IN2&amp;newvalue[0]=3.2&amp;newvalue[1]=2&amp;newvalue[1]=1</code>
		<h2>GetEP</h2>
		<p>Gets the engineering properties of an object. Can give all childrens with the parameter <code>requestType</code>(default, <code>OT_DOMAIN</code>), variables (<code>OT_VARIABLE</code>), links (<code>OT_LINK</code>) or all (<code>OT_ANY</code>)</p>
		example: <code>/getEP?format=ksx&amp;path=/TechUnits/add1</code><br>
		example: <code>/getEP?format=ksx&amp;path=/TechUnits/add1&amp;requestType=OT_ANY</code><br>
		<h2>createObject</h2>
		<p>Instantiates new objects.</p>
		example: <code>/createObject?format=ksx&amp;path=/TechUnits/add1&amp;factory=/acplt/iec61131stdfb/add</code><br>
		example: <code>/createObject?format=ksx&amp;Path[1]=/TechUnits/add1&amp;path[2]=/TechUnits/add2&amp;factory=/acplt/iec61131stdfb/add</code><br>
		<h2>deleteObject</h2>
		<p>Deletes objects.</p>
		example: <code>/deleteObject?format=ksx&amp;path=/TechUnits/add1</code><br>
		example: <code>/deleteObject?format=ksx&amp;path[1]=/TechUnits/add1&amp;path[2]=/TechUnits/add2</code><br>
		<h2>renameObject</h2>
		<p>Renames objects.</p>
		example: <code>/renameObject?format=ksx&amp;path=/TechUnits/add1&amp;newname=/TechUnits/add2</code><br>
		example: <code>/renameObject?format=ksx&amp;path[1]=/TechUnits/add1&amp;path[2]=/TechUnits/sub1&amp;newname[1]=/TechUnits/add2&amp;newname[2]=/TechUnits/sub2</code><br>
		<h2>linkObject</h2>
		<p>Links two pairs of objects with an OV association.</p>
		example: <code>/link?format=ksx&amp;path=/TechUnits/add1.taskparent&amp;element=/UrTask</code><br>
		example: <code>/link?format=ksx&amp;path[0]=/TechUnits/add1.taskparent&amp;element[0]=/UrTask&amp;path[1]=/TechUnits/add2.taskparent&amp;element[1]=/UrTask</code><br>
		<h2>unlinkObject</h2>
		<p>Unlinks two pairs of objects with an OV association.</p>
		example: <code>/unlink?format=ksx&amp;path=/TechUnits/add1.taskparent&amp;element=/UrTask</code><br>
		example: <code>/unlink?format=ksx&amp;path[0]=/TechUnits/add1.taskparent&amp;element[0]=/UrTask&amp;path[1]=/TechUnits/add2.taskparent&amp;element[1]=/UrTask</code><br>
		
		<script type="text/javascript" >
		var CommandPlayground = document.getElementById("idCommandPlayground");
		var Servicelist = document.getElementById("idServicelist");
		var Submitbutton = document.getElementById("idSubmitbutton");
		var PathInput = document.getElementById("idPathInput");
		var SecondtextSpan = document.getElementById("idSecondtextSpan");
		var SecondtextInput = document.getElementById("idSecondtextInput");
		var SecondtextLabel = document.getElementById("idSecondtextLabel");
		var SpanGetepRequestType = document.getElementById("idSpanGetepRequestType");
		var GetepRequestTypeSelect = document.getElementById("idGetepRequestTypeSelect");
		var Urldisplay = document.getElementById("idUrldisplay");
		var PlaygroundOutput = document.getElementById("idPlaygroundOutput");
		
		if( window.addEventListener ) {
			window.addEventListener('load',function(){prepareWebpage();},false);
		}
		var prepareWebpage = function(){
			//show playground
			if (-1 !== window.location.protocol.indexOf('http') && window.XMLHttpRequest){
				//show playground
				if(CommandPlayground){
					CommandPlayground.style.display = "block";
				}
				
				//test HMI and other services if transfered via http
				var ServicesNode = document.getElementById("idServices");
				if(ServicesNode && !!window.XMLHttpRequest){
					var req = new XMLHttpRequest();
					req.open("HEAD", "/hmi/", false);
					try{
						req.send(null);
						if(req.status == 200){
							ServicesNode.innerHTML = "<h1>Human-Machine Interface</h1><p>A <a href='/hmi/'>HMI Service</a> is available on this server.</p>";
						}
					}catch(e){
						//do nothing
					};
				}
			}
		};
		Servicelist.onchange = function(evt){
			if(Servicelist.options[Servicelist.options.selectedIndex].value == "none"){
				SecondtextSpan.style.display = "none";
				SpanGetepRequestType.style.display = "none";
			}else if(Servicelist.options[Servicelist.options.selectedIndex].value == "getEP"){
				SecondtextSpan.style.display = "none";
				SpanGetepRequestType.style.display = "inline";
			}else if(Servicelist.options[Servicelist.options.selectedIndex].value == "setVar"){
				SecondtextLabel.innerHTML = "new value: ";
				SecondtextSpan.style.display = "inline";
				SpanGetepRequestType.style.display = "none";
			}else{
				SecondtextSpan.style.display = "none";
				SpanGetepRequestType.style.display = "none";
			}
			calculateUrl();
		};
		Submitbutton.onclick = function(evt){
			var urlstring = calculateUrl();
			var req = new XMLHttpRequest();
			req.open("GET", urlstring, true);
			req.timeout = 10000;
			req.onreadystatechange = RequestStatehandler;
			try{
				req.send();
			}catch(err){
				PlaygroundOutput.innerHTML = "transmit error: "+err;
				PlaygroundOutput.style.borderColor = "red";
			}
		};
		var calculateUrl = function(){
			var urlstring = "/"+Servicelist.options[Servicelist.options.selectedIndex].value+"?format=ksx";
			if(Servicelist.options[Servicelist.options.selectedIndex].value == "none"){
				//nothing selected
				return;
			}else if(Servicelist.options[Servicelist.options.selectedIndex].value == "getEP"){
				urlstring += "&path="+PathInput.value;
				urlstring += "&requestType="+GetepRequestTypeSelect.options[GetepRequestTypeSelect.options.selectedIndex].value;
			}else if(Servicelist.options[Servicelist.options.selectedIndex].value == "getVar"){
				urlstring += "&path="+PathInput.value;
			}else if(Servicelist.options[Servicelist.options.selectedIndex].value == "setVar"){
				urlstring += "&path="+PathInput.value;
				urlstring += "&newvalue="+SecondtextInput.value;
			}else{
				return;
			}
			Urldisplay.value = urlstring;
			return urlstring;
		}
		PathInput.onkeyup = PathInput.onchange = calculateUrl;
		SecondtextInput.onkeyup = SecondtextInput.onchange = calculateUrl;
		GetepRequestTypeSelect.onchange = calculateUrl;
		var RequestStatehandler = function(evt){
			var req = evt.target;
			if( req.readyState == 4 ){
				PlaygroundOutput.innerHTML = req.responseText;
				if(PlaygroundOutput.rows === 2){
					PlaygroundOutput.rows = 10;
				}
				if(req.status == 200){
					PlaygroundOutput.style.borderColor = "#8080FF";
				}else{
					PlaygroundOutput.style.borderColor = "red";
				}
			}
		}
		</script>
	</body>
</html>