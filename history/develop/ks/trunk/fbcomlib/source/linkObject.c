
/******************************************************************************
 *
 *   FILE
 *   ----
 *   linkObject.c
 *
 *   History
 *   -------
 *   2013-05-18   File created
 *
 *******************************************************************************
 *
 *   This file is generated by the 'acplt_builder' command
 *
 ******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_fbcomlib
#define OV_COMPILE_LIBRARY_fbcomlib
#endif


#include "fbcomlib.h"
#include "libov/ov_macros.h"
#include "config.h"
#include "ksapi_commonFuncs.h"

OV_DLLFNCEXPORT OV_BOOL fbcomlib_linkObject_doReset_get(
		OV_INSTPTR_fbcomlib_linkObject          pobj
) {
	return pobj->v_doReset;
}

OV_DLLFNCEXPORT OV_RESULT fbcomlib_linkObject_doReset_set(
		OV_INSTPTR_fbcomlib_linkObject          pobj,
		const OV_BOOL  value
) {
	if(value && ! pobj->v_doReset)
	{
		if(pobj->p_apiLink.v_Reset)
			ksapi_KSApiCommon_Reset_set((OV_INSTPTR_ksapi_KSApiCommon) &(pobj->p_apiLink), FALSE);
		ksapi_KSApiCommon_Reset_set((OV_INSTPTR_ksapi_KSApiCommon) &(pobj->p_apiLink), TRUE);
		fbcomlib_FBComCommon_resetAbstract(Ov_StaticPtrCast(fbcomlib_FBComCommon, pobj));
	}
	pobj->v_doReset = value;
	return OV_ERR_OK;
}

OV_DLLFNCEXPORT void fbcomlib_linkObject_startup(
		OV_INSTPTR_ov_object 	pobj
) {
	/*
	 *   local variables
	 */

	/* do what the base class does first */
	fb_functionblock_startup(pobj);

	/* do what */


	return;
}

OV_DLLFNCEXPORT void fbcomlib_linkObject_typemethod(
		OV_INSTPTR_fb_functionblock	pfb,
		OV_TIME						*pltc
) {
	/*
	 *   local variables
	 */
	OV_INSTPTR_fbcomlib_linkObject pinst = Ov_StaticPtrCast(fbcomlib_linkObject, pfb);
	OV_VTBLPTR_ksapi_linkObject pVtbllinkObject = (OV_VTBLPTR_ksapi_linkObject) pclass_ksapi_linkObject->v_pvtable;
	OV_RESULT result;

	if(pinst->v_state == FBCOMLIB_STATE_WAITING)
	{	/*	waiting: calculate timeouts and check ksapi-object for answer	*/

		if(pinst->p_apiLink.v_status == KSAPI_COMMON_REQUESTCOMPLETED)
		{	/*	ksapi-request completed --> get answer	*/
			pinst->v_opResult = pinst->p_apiLink.v_result;
			fbcomlib_FBComCommon_state_set(Ov_StaticPtrCast(fbcomlib_FBComCommon, pinst), FBCOMLIB_STATE_OK);
			pinst->v_errorCode = OV_ERR_OK;
		}
		else if(pinst->p_apiLink.v_status == KSAPI_COMMON_INTERNALERROR)
		{
			fbcomlib_FBComCommon_state_set(Ov_StaticPtrCast(fbcomlib_FBComCommon, pinst), FBCOMLIB_STATE_KSAPI_ERROR);
			pinst->v_errorCode = pinst->p_apiLink.v_result;
			return;
		}
		else if(pinst->p_apiLink.v_status == KSAPI_COMMON_EXTERNALERROR)
		{
			fbcomlib_FBComCommon_state_set(Ov_StaticPtrCast(fbcomlib_FBComCommon, pinst), FBCOMLIB_STATE_EXTERNAL_ERROR);
			pinst->v_errorCode = OV_ERR_GENERIC;
			return;
		}
		else if(pinst->p_apiLink.v_status == KSAPI_COMMON_WAITINGFORANSWER)
		{
			if(pltc->secs > (pinst->v_requestSendTime.secs + pinst->v_timeout))
			{
				fbcomlib_FBComCommon_state_set(Ov_StaticPtrCast(fbcomlib_FBComCommon, pinst), FBCOMLIB_STATE_TIMEOUT);
				return;
			}
		}

	}

	if((pinst->v_state == FBCOMLIB_STATE_OK) || (pinst->v_state == FBCOMLIB_STATE_INIT))
	{	/*	ready to start	*/
		/*	ksapi-object found	*/
		if(pinst->v_sendRequested)
		{	/*	single send requested	*/
			result = ov_string_setvalue(&(pinst->p_apiLink.v_serverHost), pinst->v_host);
			if(Ov_Fail(result))
			{
				pinst->v_errorCode = result;
				fbcomlib_FBComCommon_state_set(Ov_StaticPtrCast(fbcomlib_FBComCommon, pinst), FBCOMLIB_STATE_INTERNAL_ERROR);
				return;
			}
			result = ov_string_setvalue(&(pinst->p_apiLink.v_serverName), pinst->v_server);
			if(Ov_Fail(result))
			{
				pinst->v_errorCode = result;
				fbcomlib_FBComCommon_state_set(Ov_StaticPtrCast(fbcomlib_FBComCommon, pinst), FBCOMLIB_STATE_INTERNAL_ERROR);
				return;
			}
			result = ov_string_setvalue(&(pinst->p_apiLink.v_path), pinst->v_path);
			if(Ov_Fail(result))
			{
				pinst->v_errorCode = result;
				fbcomlib_FBComCommon_state_set(Ov_StaticPtrCast(fbcomlib_FBComCommon, pinst), FBCOMLIB_STATE_INTERNAL_ERROR);
				return;
			}
			result = ov_string_setvalue(&(pinst->p_apiLink.v_elementPath), pinst->v_elementPath);
			if(Ov_Fail(result))
			{
				pinst->v_errorCode = result;
				fbcomlib_FBComCommon_state_set(Ov_StaticPtrCast(fbcomlib_FBComCommon, pinst), FBCOMLIB_STATE_INTERNAL_ERROR);
				return;
			}
			result = ov_string_setvalue(&(pinst->p_apiLink.v_placePath), pinst->v_placePath);
			if(Ov_Fail(result))
			{
				pinst->v_errorCode = result;
				fbcomlib_FBComCommon_state_set(Ov_StaticPtrCast(fbcomlib_FBComCommon, pinst), FBCOMLIB_STATE_INTERNAL_ERROR);
				return;
			}
			pinst->p_apiLink.v_position = pinst->v_position;
		}
		if(pinst->v_sendRequested || pinst->v_doCyclic)
		{	/*	send Requested or cyclic sending requested	*/

			if(pinst->v_doCyclic)
				pinst->p_apiLink.v_holdConnection = TRUE;
			else
				pinst->p_apiLink.v_holdConnection = FALSE;
			pVtbllinkObject->m_submit(Ov_StaticPtrCast(ksapi_KSApiCommon, &(pinst->p_apiLink)));
			fbcomlib_FBComCommon_state_set(Ov_StaticPtrCast(fbcomlib_FBComCommon, pinst), FBCOMLIB_STATE_WAITING);
			pinst->v_requestSendTime = *pltc;
			pinst->v_sendRequested = FALSE;
			return;

		}
		return;
	}
	else if(pinst->v_state != FBCOMLIB_STATE_WRONGINPUT)
	{
		if(pinst->v_doCyclic && pinst->v_retryAfter)
		{
			if(pltc->secs > (pinst->v_requestSendTime.secs + pinst->v_retryAfter))
			{
				if(pinst->v_doReset)
					fbcomlib_linkObject_doReset_set(pinst, FALSE);
				fbcomlib_linkObject_doReset_set(pinst, TRUE);
				fbcomlib_linkObject_doReset_set(pinst, FALSE);
				fbcomlib_FBComCommon_doCyclic_set(Ov_StaticPtrCast(fbcomlib_FBComCommon, pinst), TRUE);
			}

		}
	}
	return;
}

