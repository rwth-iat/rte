
/******************************************************************************
*
*   FILE
*   ----
*   pkgSetVariable.c
*
*   History
*   -------
*   2013-05-18   File created
*
*******************************************************************************
*
*   This file is generated by the 'acplt_builder' command
*
******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_fbcomlib
#define OV_COMPILE_LIBRARY_fbcomlib
#endif


#include "fbcomlib.h"
#include "libov/ov_macros.h"
#include "config.h"
#include "ksapi_commonFuncs.h"

OV_DLLFNCEXPORT OV_RESULT fbcomlib_pkgSetVariable_constructor(
	OV_INSTPTR_ov_object 	pobj
) {
    /*    
    *   local variables
    */
    OV_INSTPTR_fbcomlib_pkgSetVariable pinst = Ov_StaticPtrCast(fbcomlib_pkgSetVariable, pobj);
    OV_RESULT    result;

    /* do what the base class does first */
    result = fb_functionblock_constructor(pobj);
    if(Ov_Fail(result))
         return result;

    /* do what */
    pinst->v_actimode = 1;
    pinst->v_iexreq = 1;

    return OV_ERR_OK;
}

OV_DLLFNCEXPORT void fbcomlib_pkgSetVariable_typemethod(
	OV_INSTPTR_fb_functionblock	pfb,
	OV_TIME						*pltc
) {
    /*    
    *   local variables
    */
    OV_INSTPTR_fbcomlib_pkgSetVariable pinst = Ov_StaticPtrCast(fbcomlib_pkgSetVariable, pfb);
    OV_INSTPTR_fbcomlib_setVar	pSetVar = Ov_GetParent(fbcomlib_PkgVar, pinst);
    OV_RESULT result;

    if(pSetVar)
    {	/*	we are connected to a parent getVar	*/
    	if((pSetVar->v_state == FBCOMLIB_STATE_OK) ||(pSetVar->v_state == FBCOMLIB_STATE_INIT))
    	{	/*	ready to start	*/
    		/*	ksapi-object found	*/
    		if(!pSetVar->v_doCyclic)
    		{	/*	single send requested	*/
    			result = ov_string_setvalue(&(pinst->p_apiVar.v_path), pinst->v_path);
    			if(Ov_Fail(result))
    			{
    				pSetVar->v_errorCode = result;
    				fbcomlib_FBComCommon_state_set(Ov_StaticPtrCast(fbcomlib_FBComCommon, pSetVar), FBCOMLIB_STATE_INTERNAL_ERROR);
    				return;
    			}
    		}
    		/*	propagate value to ksapi object	*/
    		if(Ov_Fail(Ov_SetAnyValue(&(pinst->p_apiVar.v_varValue), &(pinst->v_value))))
    			fbcomlib_FBComCommon_state_set(Ov_StaticPtrCast(fbcomlib_FBComCommon, pSetVar), FBCOMLIB_STATE_INTERNAL_ERROR);
    	}
    	if(pSetVar->v_state == FBCOMLIB_STATE_OK)
    	{
    		if(pSetVar->p_apiSet.v_status == KSAPI_COMMON_REQUESTCOMPLETED)
    		{	/*	ksapi-request completed --> get answer	*/
    			pinst->v_varResult = pinst->p_apiVar.v_varRes;
    			return;
    		}
    		return;
    	}

    }
    return;
}

