
/******************************************************************************
*
*   FILE
*   ----
*   xdrManagerCom.c
*
*   History
*   -------
*   2013-02-07   File created
*
*******************************************************************************
*
*   This file is generated by the 'acplt_builder' command
*
******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_ksxdr
#define OV_COMPILE_LIBRARY_ksxdr
#endif


#include "ksxdr.h"
#include "libov/ov_macros.h"
#include "libov/ov_vendortree.h"
#include "ks_logfile.h"
#include "ksxdr_config.h"


OV_DLLFNCEXPORT void ksxdr_xdrManagerCom_startup(
	OV_INSTPTR_ov_object 	pobj
) {
    /*    
    *   local variables
    */
    OV_INSTPTR_ksxdr_xdrManagerCom pinst = Ov_StaticPtrCast(ksxdr_xdrManagerCom, pobj);

    /* do what the base class does first */
    ov_object_startup(pobj);

    /* do what */
    pinst->v_cycInterval = 5000; /*	cycle every 5 seconds at first	*/
    pinst->v_actimode = 1;

    return;
}

OV_DLLFNCEXPORT void ksxdr_xdrManagerCom_shutdown(
	OV_INSTPTR_ov_object 	pobj
) {
    /*    
    *   local variables
    */
    OV_INSTPTR_ksxdr_xdrManagerCom pinst = Ov_StaticPtrCast(ksxdr_xdrManagerCom, pobj);

    /* do what */

//TODO issue unregister command

    /* set the object's state to "shut down" */
    ov_object_shutdown(pobj);

    return;
}

OV_DLLFNCEXPORT OV_RESULT ksxdr_xdrManagerCom_HandleData(
	OV_INSTPTR_ksbase_DataHandler this,
	KS_DATAPACKET* dataReceived,
	KS_DATAPACKET* answer
) {
    /*    
    *   local variables
    */
	//TODO process answer of register requests
    return OV_ERR_OK;
}

OV_DLLFNCEXPORT void ksxdr_xdrManagerCom_typemethod (
	OV_INSTPTR_ksbase_ComTask	this
) {
    /*    //TODO everything here!!!
    *   local variables
    */
	OV_INSTPTR_ksxdr_xdrManagerCom thisMngCom = Ov_StaticPtrCast(ksxdr_xdrManagerCom, this);
	OV_INSTPTR_ksbase_Manager pManager = NULL;

	if(thisMngCom->v_Tries < 5)
	{
		if(thisMngCom->v_UseShortCut == TRUE)
		{
			pManager = Ov_StaticPtrCast(ksbase_Manager, Ov_GetFirstChild(ov_instantiation, pclass_ksbase_Manager));
			if(!pManager)
			{
				KS_logfile_error(("%s: typemethod: no Manager here. Cannot register", this->v_identifier));
				return;
			}

			KS_logfile_debug(("%s: registering MANAGER ksxdr protocol on port %s", thisMngCom->v_identifier, thisMngCom->v_OwnPort));
			if(Ov_Fail(ksbase_Manager_register("MANAGER", 2, KSXDR_IDENTIFIER, thisMngCom->v_OwnPort, 30)))
			{
				thisMngCom->v_RegisterState = 128;	/*	set register error	*/
				thisMngCom->v_Tries++;
				return;
			}
			else
			{
				thisMngCom->v_RegisterState = 2;	/*	set state to registered and slow down typemethod	*/
				thisMngCom->v_cycInterval = 30000;	/*	re-register every 30 seconds (assuming rootcomtask runs at 1 msec	*/
				thisMngCom->v_Tries = 0;
				return;
			}
		}
	}
	else
	{
		KS_logfile_error(("%s: registering at Manager failed 5 times. deactivating typemethod.", thisMngCom->v_identifier));
		thisMngCom->v_actimode = 0;
		return;
	}

    return;
}


