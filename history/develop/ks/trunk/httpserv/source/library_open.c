
/******************************************************************************
*
*   FILE
*   ----
*   library_open.c
*
*   History
*   -------
*   2012-02-21   File created
*
*******************************************************************************
*
*   This file is generated by the 'acplt_builder' command
*
******************************************************************************/
#ifndef OV_COMPILE_LIBRARY_httpserv
#define OV_COMPILE_LIBRARY_httpserv
#endif

#include "httpserv.h"

#ifdef ov_library_open_httpserv
#undef ov_library_open_httpserv
#endif


#include "libov/ov_macros.h"
#include "libov/ov_path.h"
#include "libov/ov_string.h"
#include "libov/ov_logfile.h"

/*
* This function will be called, when the library is loaded.
* It could generate components and initializes the startup procedure
*/
OV_RESULT ov_library_setglobalvars_httpserv_new(void) {
	OV_RESULT result;

	OV_INSTPTR_ov_domain 			domain = NULL;
	OV_INSTPTR_ov_domain			phttpservers  = NULL;
	OV_INSTPTR_ov_domain			pcommunication  = NULL;
	OV_INSTPTR_httpserv_httpserver	phttpserver  = NULL;
	OV_INSTPTR_ov_domain			pstaticfiles = NULL;
	OV_INSTPTR_httpserv_staticfile	pindexhtml  = NULL;

	/*
	 *    set the global variables of the original version
	 *    and if successful, load other libraries
	 *    and create some objects
	 */
	result = ov_library_setglobalvars_httpserv();

	if(Ov_OK(result))
	{
		/*
		*       get "/" pointer
		*/
		domain = (OV_INSTPTR_ov_domain)ov_path_getobjectpointer("/", 2);
		if(!domain)
		{
			ov_logfile_error("Fatal: Could not find Domain '/'! - Fatal Error");
			return OV_ERR_GENERIC;
		}



		/*
		*       create communication container
		*/
		//communication container should be provided by ksserv
		pcommunication = (OV_INSTPTR_ov_domain)Ov_SearchChild(ov_containment, domain, "communication");
		if(!pcommunication)
		{
			result = Ov_CreateObject(ov_domain, pcommunication, domain, "communication");
			if(Ov_Fail(result))
			{
				ov_logfile_error("Fatal: Could not create Object 'communication'");
				return result;
			}
		}

		/*
		*       create httpservers container
		*/
		phttpservers = (OV_INSTPTR_ov_domain)Ov_SearchChild(ov_containment, pcommunication, "httpservers");
		if(!phttpservers)
		{
			result = Ov_CreateObject(ov_domain, phttpservers, pcommunication, "httpservers");

			if(Ov_Fail(result))
			{
				ov_logfile_error("Fatal: Could not create Object 'httpservers'");
				return result;
			}
		}

		/*
		*       create "httpserver" object
		*/
	   phttpserver = (OV_INSTPTR_httpserv_httpserver)Ov_SearchChild(ov_containment, phttpservers, "httpserver");
	   if(!phttpserver)
	   {
    	   result = Ov_CreateObject(httpserv_httpserver, phttpserver, phttpservers, "httpserver");
    	   if(Ov_Fail(result))
    	   {
				ov_logfile_error("Fatal: Could not create Object 'httpserver'");
			   return result;
		   }
		}

	   /*
	    * 		create "staticfiles" container
	    */
		pstaticfiles = (OV_INSTPTR_ov_domain)Ov_SearchChild(ov_containment, phttpserver, "staticfiles");
		if(!phttpservers)
		{
			result = Ov_CreateObject(ov_domain, pstaticfiles, phttpserver, "staticfiles");

			if(Ov_Fail(result))
			{
				ov_logfile_error("Fatal: Could not create Object 'staticfiles'");
				return result;
			}
		}

		/*
		 * 		create "index.html"
		 */
		pindexhtml = (OV_INSTPTR_httpserv_staticfile)Ov_SearchChild(ov_containment, pstaticfiles, "index.html");
		if(!pindexhtml)
		{
			result = Ov_CreateObject(httpserv_staticfile, pindexhtml, pstaticfiles, "index.html");

			if(Ov_Fail(result))
			{
				ov_logfile_error("Fatal: Could not create Object 'index.html'");
				return result;
			}

			//set value
			ov_string_setvalue(&(pindexhtml->v_content), "<html><h2>It works!</h2>Powered by ACPLT/OV.</html>");

		}
	}

	return result;
}
/*
*       Replace the 'setglobalvars' function of a library with this
*       previous one, which additionally creates instances.
* 	This is called by the OV system upon library load.
*/
OV_DLLFNCEXPORT OV_LIBRARY_DEF *ov_library_open_httpserv(void) {
	/* local variables */
	static OV_LIBRARY_DEF *OV_LIBRARY_DEF_httpserv_new;
	/*
	*       replace the 'setglobalvars' function created by the code generator
	*       with a new one.
	*/
	OV_LIBRARY_DEF_httpserv_new = ov_library_open_httpserv_old();
	OV_LIBRARY_DEF_httpserv_new->setglobalvarsfnc = ov_library_setglobalvars_httpserv_new;
	return OV_LIBRARY_DEF_httpserv_new;
}
