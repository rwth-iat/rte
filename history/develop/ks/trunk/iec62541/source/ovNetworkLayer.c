
/******************************************************************************
*
*   FILE
*   ----
*   ovNetworkLayer.c
*
*   History
*   -------
*   2015-06-02   File created
*
*******************************************************************************
*
*   This file is generated by the 'acplt_builder' command
*
******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_iec62541
#define OV_COMPILE_LIBRARY_iec62541
#endif


#include "iec62541.h"
#include "libov/ov_macros.h"
#include "ks_logfile.h"

static OV_INSTPTR_iec62541_ovNetworkLayer pOVNetworkLayer	=	NULL;

OV_INSTPTR_iec62541_ovNetworkLayer getOvNetworkLayer(){
	return pOVNetworkLayer;
}

UA_ServerNetworkLayer ServerNetworkLayerOV_new(UA_ConnectionConfig conf, UA_UInt32 port) {
    OV_INSTPTR_iec62541_ovNetworkLayer	pNetworkLayer	=	NULL;
    OV_VTBLPTR_iec62541_ovNetworkLayer	pVtblNetworkLayer	=	NULL;
    OV_RESULT							result;
	UA_ServerNetworkLayer nl;
    memset(&nl, 0, sizeof(UA_ServerNetworkLayer));

    result = Ov_CreateIDedObject(iec62541_ovNetworkLayer, pNetworkLayer, Ov_StaticPtrCast(ov_domain, Ov_GetFirstChild(ov_instantiation, pclass_iec62541_uaServer)), "ovNetworkLayer");
    if(Ov_Fail(result)){
    	return nl;
    }

    char hostname[256];
    gethostname(hostname, 255);
    if(*hostname){
    UA_String_copyprintf("opc.tcp://%s:%d", &(pNetworkLayer->v_discoveryUrlInternal), hostname, port);
    } else {
    	UA_String_copyprintf("opc.tcp://%s:%d", &(pNetworkLayer->v_discoveryUrlInternal), "localhost", port);
    }

    pNetworkLayer->v_localConfig = conf;
    Ov_GetVTablePtr(iec62541_ovNetworkLayer, pVtblNetworkLayer, pNetworkLayer);
    nl.nlHandle = pNetworkLayer;
    nl.start = (UA_StatusCode (*)(void*, UA_Logger *logger))pVtblNetworkLayer->m_start;
    nl.getWork = (UA_Int32 (*)(void*, UA_WorkItem**, UA_UInt16))pVtblNetworkLayer->m_getWork;
    nl.stop = (UA_Int32 (*)(void*, UA_WorkItem**))pVtblNetworkLayer->m_stop;
    nl.free = (void (*)(void*))pVtblNetworkLayer->m_delete;
    nl.discoveryUrl = &(pNetworkLayer->v_discoveryUrlInternal);
    return nl;
}


OV_DLLFNCEXPORT OV_STRING iec62541_ovNetworkLayer_discoveryUrl_get(
    OV_INSTPTR_iec62541_ovNetworkLayer          pobj
) {
	OV_STRING tempString = NULL;
    if(pobj->v_discoveryUrlInternal.length > 0){
    	tempString = ov_memstack_alloc((pobj->v_discoveryUrlInternal.length + 1) * sizeof(char));
    	if(!tempString){
    		return NULL;
    	} else {
    		memcpy(tempString, pobj->v_discoveryUrlInternal.data, pobj->v_discoveryUrlInternal.length);
    		tempString[pobj->v_discoveryUrlInternal.length] = '\0';
    	}
    }
	return tempString;
}

OV_DLLFNCEXPORT OV_RESULT iec62541_ovNetworkLayer_constructor(
	OV_INSTPTR_ov_object 	pobj
) {
    /*    
    *   local variables
    */
    OV_INSTPTR_iec62541_ovNetworkLayer pinst = Ov_StaticPtrCast(iec62541_ovNetworkLayer, pobj);
    OV_INSTPTR_ov_object	pOtherObject	=	NULL;
    OV_RESULT    result;

    /* do what the base class does first */
    result = ov_object_constructor(pobj);
    if(Ov_Fail(result))
         return result;

    /* do what */
    Ov_ForEachChild(ov_instantiation, pclass_iec62541_ovNetworkLayer, pOtherObject){
    	if(pOtherObject != pobj){
    		KS_logfile_error(("%s: cannot instantiate - ovNetworkLayer instance already exists", pinst->v_identifier));
    		return OV_ERR_ALREADYEXISTS;
    	}
    }

    return OV_ERR_OK;
}

OV_DLLFNCEXPORT void iec62541_ovNetworkLayer_destructor(
	OV_INSTPTR_ov_object 	pobj
) {
    /*    
    *   local variables
    */
//    OV_INSTPTR_iec62541_ovNetworkLayer pinst = Ov_StaticPtrCast(iec62541_ovNetworkLayer, pobj);

    /* do what */

    /* destroy object */
    ov_object_destructor(pobj);

    return;
}

OV_DLLFNCEXPORT void iec62541_ovNetworkLayer_startup(
	OV_INSTPTR_ov_object 	pobj
) {
    /*    
    *   local variables
    */
    OV_INSTPTR_iec62541_ovNetworkLayer pinst = Ov_StaticPtrCast(iec62541_ovNetworkLayer, pobj);

    /* do what the base class does first */
    ov_object_startup(pobj);

    /* do what */
    pOVNetworkLayer = pinst;

    return;
}

OV_DLLFNCEXPORT void iec62541_ovNetworkLayer_shutdown(
	OV_INSTPTR_ov_object 	pobj
) {
    /*    
    *   local variables
    */
//    OV_INSTPTR_iec62541_ovNetworkLayer pinst = Ov_StaticPtrCast(iec62541_ovNetworkLayer, pobj);

    /* do what */
    pOVNetworkLayer = NULL;
   // UA_String_delete(&(pOVNetworkLayer->v_discoveryUrlInternal));
    /* set the object's state to "shut down" */
    ov_object_shutdown(pobj);

    return;
}

OV_DLLFNCEXPORT OV_ACCESS iec62541_ovNetworkLayer_getaccess(
	OV_INSTPTR_ov_object	pobj,
	const OV_ELEMENT		*pelem,
	const OV_TICKET			*pticket
) {
	switch(pelem->elemtype) {
	case OV_ET_VARIABLE:
		if(pelem->elemunion.pvar->v_offset >= offsetof(OV_INST_ov_object,__classinfo)) {
			if(pelem->elemunion.pvar->v_vartype == OV_VT_CTYPE)
				return OV_AC_NONE;
			else{
				if((pelem->elemunion.pvar->v_varprops & OV_VP_DERIVED)){
					if((pelem->elemunion.pvar->v_varprops & OV_VP_SETACCESSOR)){
						return OV_AC_READWRITE;
					} else {
						return OV_AC_READ;
					}
				} else {
					return OV_AC_READWRITE;
				}
			}
		}
		break;
	default:
		break;
	}

	return ov_object_getaccess(pobj, pelem, pticket);
}

OV_DLLFNCEXPORT UA_StatusCode iec62541_ovNetworkLayer_start(
	OV_INSTPTR_iec62541_ovNetworkLayer this, 
	UA_Logger *logger
) {

    return (UA_StatusCode)0;
}

OV_DLLFNCEXPORT UA_Int32 iec62541_ovNetworkLayer_getWork(
	OV_INSTPTR_iec62541_ovNetworkLayer this, 
	UA_WorkItem** items, 
	UA_UInt16 timeout
) {

	OV_INSTPTR_iec62541_uaConnection	pConnection	=	NULL;
	OV_UINT								counter		=	0;
	UA_WorkItem 						*newItems	=	NULL;

	/*	count work items	*/
	Ov_ForEachChild(iec62541_networkLayerToConnection, this, pConnection){
		if(pConnection->v_workNext == TRUE){
			counter++;
		}

	}

	newItems = malloc(sizeof(UA_WorkItem)*(counter+1));
	if(!newItems){
		items = NULL;
		return 0;
	}
	/*	iterate and collect work	*/
	counter = 0;
	Ov_ForEachChild(iec62541_networkLayerToConnection, this, pConnection){
		if(pConnection->v_workNext == TRUE){
			if(pConnection->v_closeConn != TRUE){
				newItems[counter].type = UA_WORKITEMTYPE_BINARYMESSAGE;
				newItems[counter].work.binaryMessage.message = pConnection->v_buffer;
				newItems[counter].work.binaryMessage.connection = &(pConnection->v_connection);
			} else {
				newItems[counter].type = UA_WORKITEMTYPE_CLOSECONNECTION;
				newItems[counter].work.closeConnection = &(pConnection->v_connection);
			}
			pConnection->v_workNext = FALSE;
			counter++;
		}
	}
	if(counter == 0) {
		free(newItems);
		*items = NULL;
	} else
		*items = newItems;
	return counter;
}

OV_DLLFNCEXPORT UA_Int32 iec62541_ovNetworkLayer_stop(
	OV_INSTPTR_iec62541_ovNetworkLayer this, 
	UA_WorkItem** items
) {

    return (UA_Int32)0;
}

OV_DLLFNCEXPORT void iec62541_ovNetworkLayer_delete(
	OV_INSTPTR_iec62541_ovNetworkLayer this
) {
	Ov_DeleteObject(pOVNetworkLayer);
	pOVNetworkLayer = NULL;
    return;
}

