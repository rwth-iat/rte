
/******************************************************************************
*
*   FILE
*   ----
*   uaServer.c
*
*   History
*   -------
*   2014-10-14   File created
*
*******************************************************************************
*
*   This file is generated by the 'acplt_builder' command
*
******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_iec62541
#define OV_COMPILE_LIBRARY_iec62541
#endif


#include "iec62541.h"
#include "libov/ov_macros.h"
#include "ks_logfile.h"
#include "ua_types.h"
#include "ua_server.h"
#include "server/ua_nodestore.h"

/*	function declaration needed as they are declared with __declspec(dllimport) in the header which means they MUST come from a dll not an .a	*/
UA_Int32 UA_String_copycstring(char const *src, UA_String *dst);
void UA_String_deleteMembers(UA_String *p);
void UA_Server_init(UA_Server *server, UA_String *endpointUrl);
UA_Int32 UA_Server_deleteMembers(UA_Server *server);

OV_INSTPTR_iec62541_uaServer iec62541_pUaServer = NULL;

OV_DLLFNCEXPORT OV_RESULT iec62541_uaServer_endpointName_set(
    OV_INSTPTR_iec62541_uaServer          pobj,
    const OV_STRING  value
) {
	OV_RESULT result;
	result = ov_string_setvalue(&pobj->v_endpointName,value);
	if(Ov_Fail(result)){
		return result;
	}
	if(UA_String_copycstring(value, &(pobj->v_endpointUrl)) != UA_STATUSCODE_GOOD){
		return OV_ERR_GENERIC;
	}
	return OV_ERR_OK;
}

OV_DLLFNCEXPORT OV_RESULT iec62541_uaServer_constructor(
	OV_INSTPTR_ov_object 	pobj
) {
    /*    
    *   local variables
    */
    OV_INSTPTR_iec62541_uaServer pinst = Ov_StaticPtrCast(iec62541_uaServer, pobj);
    OV_RESULT    result;
    OV_INSTPTR_ov_object pOtherObject = NULL;
    OV_INSTPTR_iec62541_uaNamespace0	pNs0 = NULL;
    /* do what the base class does first */
    result = ov_object_constructor(pobj);
    if(Ov_Fail(result))
         return result;

    /* do what */
    Ov_ForEachChild(ov_instantiation, pclass_iec62541_uaServer, pOtherObject){
    	if(pOtherObject != pobj){
    		KS_logfile_error(("%s: cannot instantiate - uaServer instance already exists", pinst->v_identifier));
    		return OV_ERR_ALREADYEXISTS;
    	}
    }

    result = Ov_CreateObject(iec62541_uaNamespace0, pNs0, pinst, "ns0");
    if(Ov_Fail(result) && (result != OV_ERR_ALREADYEXISTS))
    {
    	return result;
    }

    return OV_ERR_OK;
}

OV_DLLFNCEXPORT void iec62541_uaServer_destructor(
	OV_INSTPTR_ov_object 	pobj
) {
    /*    
    *   local variables
    */
    OV_INSTPTR_iec62541_uaServer pinst = Ov_StaticPtrCast(iec62541_uaServer, pobj);

    /* do what */

    /* destroy object */
    ov_object_destructor(pobj);

    return;
}

OV_DLLFNCEXPORT void iec62541_uaServer_startup(
	OV_INSTPTR_ov_object 	pobj
) {
    /*    
    *   local variables
    */
    OV_INSTPTR_iec62541_uaServer pinst = Ov_StaticPtrCast(iec62541_uaServer, pobj);
    /* do what the base class does first */
    ov_object_startup(pobj);

    /* do what */
    iec62541_pUaServer = pinst;
    UA_String_copycstring(pinst->v_endpointName, &(pinst->v_endpointUrl));
    UA_Server_init(&(pinst->v_serverData), &(pinst->v_endpointUrl));
    UA_Server_addNamespace(&(pinst->v_serverData),0,&(pinst->v_nodeStoreNs0));
    UA_Server_addNamespace(&(pinst->v_serverData),42,&(pinst->v_nodeStoreNsOV));

    UA_NodeStore_registerReadNodesOperation(&(pinst->v_nodeStoreNs0),
    		((OV_VTBLPTR_iec62541_nodeStoreFunctions)pclass_iec62541_uaNamespace0->v_pvtable)->m_readNodes);
    UA_NodeStore_registerBrowseNodesOperation(&(pinst->v_nodeStoreNs0),
       		((OV_VTBLPTR_iec62541_nodeStoreFunctions)pclass_iec62541_uaNamespace0->v_pvtable)->m_browseNodes);
    UA_NodeStore_registerReadNodesOperation(&(pinst->v_nodeStoreNsOV),
    		((OV_VTBLPTR_iec62541_nodeStoreFunctions)pclass_iec62541_nodeStoreFunctions->v_pvtable)->m_readNodes);
    return;
}

OV_DLLFNCEXPORT void iec62541_uaServer_shutdown(
	OV_INSTPTR_ov_object 	pobj
) {
    /*    
    *   local variables
    */
    OV_INSTPTR_iec62541_uaServer pinst = Ov_StaticPtrCast(iec62541_uaServer, pobj);

    /* do what */
    UA_Server_deleteMembers(&(pinst->v_serverData));
    UA_String_deleteMembers(&(pinst->v_endpointUrl));
    iec62541_pUaServer = NULL;
    /* set the object's state to "shut down" */
    ov_object_shutdown(pobj);


    return;
}

OV_DLLFNCEXPORT OV_ACCESS iec62541_uaServer_getaccess(
	OV_INSTPTR_ov_object	pobj,
	const OV_ELEMENT		*pelem,
	const OV_TICKET			*pticket
) {
	switch(pelem->elemtype) {
	case OV_ET_VARIABLE:
		if(pelem->elemunion.pvar->v_offset >= offsetof(OV_INST_ov_object,__classinfo)) {
			if(pelem->elemunion.pvar->v_vartype == OV_VT_CTYPE)
				return OV_AC_NONE;
			else
				return OV_AC_READWRITE;
		}
		break;
	default:
		break;
	}

	return ov_object_getaccess(pobj, pelem, pticket);
}
