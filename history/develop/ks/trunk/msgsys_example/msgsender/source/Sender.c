
/******************************************************************************
*
*   FILE
*   ----
*   MsgComponent.c
*
*   History
*   -------
*   2010-03-26   File created
*
*******************************************************************************
*
*   This file is generated by the 'fb_builder' command
*
******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_msgsender
#define OV_COMPILE_LIBRARY_msgsender
#endif


#include "msgsender.h"
#include "senderconfig.h"

OV_DLLFNCEXPORT OV_RESULT msgsender_Sender_sendCMD_set(
    OV_INSTPTR_msgsender_Sender         pobj,
    const OV_INT  value
) {
	OV_INSTPTR_msgsys_MsgComponent msgsys = NULL;
	OV_INSTPTR_msgsys_Message	message = NULL;
	OV_INSTPTR_ov_domain	msgsys_domain = NULL;
	OV_VTBLPTR_msgsender_Sender thisVtable = NULL;

	msgsys_domain = (OV_INSTPTR_ov_domain)ov_path_getobjectpointer("/TechUnits/Sender/Outbox", 2);
	if(msgsys_domain)ov_logfile_debug("Outbox found");
	else{
		ov_logfile_debug("Outbox not found");
		return OV_ERR_OK;
	}

	msgsys = (OV_INSTPTR_msgsys_MsgComponent) ov_path_getobjectpointer("/TechUnits/MsgSys", 2);
	Ov_GetVTablePtr(msgsender_Sender, thisVtable, pobj);

	message = (OV_INSTPTR_msgsys_Message)Ov_GetFirstChild(ov_containment,msgsys_domain);
	while(message){
		if(message->v_msgStatus == MSGNEW){
			msgsys_MsgComponent_sendMessage(msgsys,message,thisVtable->m_retMethod);
			ov_logfile_debug("Sender: sendCMD: Message sent!");
			//Ov_DeleteObject(message);
		}
			
		message = (OV_INSTPTR_msgsys_Message)Ov_GetNextChild(ov_containment,message);
	}



	pobj->v_sendCMD = value;
    return OV_ERR_OK;
}

OV_DLLFNCEXPORT OV_RESULT msgsender_Sender_constructor(
	OV_INSTPTR_ov_object 	pobj
) {
    /*    
    *   local variables
    */
	OV_INSTPTR_msgsender_Sender this = Ov_StaticPtrCast(msgsender_Sender, pobj);
	OV_RESULT result = fb_functionblock_constructor(pobj);
	OV_VTBLPTR_msgsender_Sender thisVtable = NULL;
	OV_INSTPTR_msgsys_MsgComponent msgsys = NULL;


    /* do what the base class does first */


    if(Ov_Fail(result))
        return result;
			this->v_iexreq = TRUE;
			this->v_cyctime = SENDERCYCTIME;
			this->v_actimode = TRUE;

    /* do what */
	msgsys = (OV_INSTPTR_msgsys_MsgComponent) ov_path_getobjectpointer("/TechUnits/MsgSys", 2);
	Ov_GetVTablePtr(msgsender_Sender, thisVtable, this);
	msgsys_MsgComponent_registerService(msgsys,"Sender","/TechUnits/Sender/Inbox",thisVtable->m_arrivalMethod);


    return OV_ERR_OK;
}

OV_DLLFNCEXPORT void msgsender_Sender_retMethod(
						   OV_INSTPTR_ov_object pobj,
						   OV_INSTPTR_ov_object message,
						   OV_STRING errorstring,
						   OV_INT errorcode
){
	OV_INSTPTR_msgsys_Message msg = Ov_StaticPtrCast(msgsys_Message, message);
	ov_logfile_debug("Sender: retMethod: Called with %d/%s for Message: %s with ID: %lu !",errorcode,errorstring,msg->v_identifier,msg->v_msgID);
	ov_logfile_debug("Sender: retMethod: Calling now the registered retMethod");

	return;
}

OV_DLLFNCEXPORT void msgsender_Sender_arrivalMethod(
						   OV_INSTPTR_ov_object pobj,
						   OV_INSTPTR_ov_object message
){
	OV_INSTPTR_msgsys_Message msg = Ov_StaticPtrCast(msgsys_Message, message);
	ov_logfile_debug("Sender: arrivalMethod: Called for Message: %s with ID: %lu !",msg->v_identifier,msg->v_msgID);

	return;
}


OV_DLLFNCEXPORT void msgsender_Sender_typemethod(
	OV_INSTPTR_fb_functionblock	pfb,
	OV_TIME						*pltc
) {
    /*    
    *   local variables
    */
	//OV_INSTPTR_msgsys_MessageBox this = Ov_StaticPtrCast(msgsys_MessageBox, pfb);

	return;
}
