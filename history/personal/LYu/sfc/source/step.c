
/******************************************************************************
*
*   FILE
*   ----
*   sfcStep.c
*
*   History
*   -------
*   2011-05-27   File created
*
*******************************************************************************
*
*   This file is generated by the 'fb_builder' command
*
******************************************************************************/


#ifndef OV_COMPILE_LIBRARY_sfc
#define OV_COMPILE_LIBRARY_sfc
#endif

#ifdef SFC_ERROR
#define SFC_STEP_ERROR
#endif


#include "sfc.h"
#include "sfclib.h"

OV_DLLFNCEXPORT OV_RESULT sfc_step_constructor(
	OV_INSTPTR_ov_object 	pobj
) {
    /*
    *   local variables
    */
    OV_INSTPTR_sfc_step pinst = Ov_StaticPtrCast(sfc_step, pobj);
    OV_INSTPTR_fb_task    pEntry = &pinst->p_entry;
    OV_INSTPTR_fb_task    pDo 	 = &pinst->p_do;
    OV_INSTPTR_fb_task    pTrans = &pinst->p_trans;
    OV_INSTPTR_fb_task    pExit  = &pinst->p_exit;

    OV_INSTPTR_ov_domain  pContainer = Ov_GetParent(ov_containment, pinst);
    OV_INSTPTR_sfc_sfcHeader pSfcHeader = NULL;
    OV_INSTPTR_fb_task    pIntask=NULL;
    OV_RESULT    result;

    /* do what the base class does first */
    result = fb_functionblock_constructor(pobj);
    if(Ov_Fail(result))
         return result;

    // check location
    if (Ov_CanCastTo(sfc_sfcHeader, pContainer))
    {
    	pSfcHeader=Ov_DynamicPtrCast(sfc_sfcHeader, pContainer);
    	//// link to intask
    	//pIntask=&pSfcHeader->p_intask;
    	//result=Ov_Link(fb_tasklist, pIntask, Ov_PtrUpCast(fb_task, pinst));
     } else {
		if (pContainer!=NULL)
		{
			ov_logfile_error("sfc_step_constructor: step must be encapsulated in a sfcHeader.");
			return OV_ERR_BADPLACEMENT;
		}
     }

    // local tasklist
    result=Ov_Link(fb_tasklist, pinst, pEntry);
    pEntry->v_actimode=3;
    result=Ov_Link(fb_tasklist, pinst, pDo);
    pDo->v_actimode=1;
    result=Ov_Link(fb_tasklist, pinst, pTrans);
    pTrans->v_actimode=1;
    result=Ov_Link(fb_tasklist, pinst, pExit);
    pExit->v_actimode=0;

    //activate
    pinst->v_iexreq=1;

    return OV_ERR_OK;
}


OV_DLLFNCEXPORT void sfc_step_typemethod(
	OV_INSTPTR_fb_functionblock	pfb,
	OV_TIME						*pltc
) {
    /*    
    *   local variables
    */
    OV_INSTPTR_sfc_step pinst = Ov_StaticPtrCast(sfc_step, pfb);

    // set the step flag
    pinst->v_X=TRUE;


    pinst->v_evTransTrigger=FALSE;


    // step flag will be resetted by trigglered transition
    return;
}

