/*
*   The Framework was generated by the ACPLT/OV Builder.
*
*   Builder version: 1.0.1
*   Date of file generation:  10-Apr-2002 (17:18:25)
*/

#ifndef OV_COMPILE_LIBRARY_dynov
#define OV_COMPILE_LIBRARY_dynov
#endif


#include "dynov.h"
#include "libov/ov_macros.h"

OV_DLLFNCEXPORT void dynov_dynstructure_uncheck(
        OV_INSTPTR_ov_object          pobj
) {
}

OV_DLLFNCEXPORT OV_BOOL dynov_dynstructure_check(
        OV_INSTPTR_ov_object          pobj
) {
        OV_INSTPTR_ov_object		        pchild;
	OV_INSTPTR_dynov_dynstructure          	pdynstruct;
	OV_INSTPTR_dynov_dynvariable          	pdynvar;
	OV_VTBLPTR_dynov_dynvariable          	pvtable;
	OV_BOOL					result;

	pdynstruct = Ov_DynamicPtrCast(dynov_dynstructure, pobj);
	if (!pdynstruct) return FALSE;
	pdynstruct->v_size = 0;
	Ov_ForEachChild(ov_containment, pdynstruct, pchild) {
		pdynvar = Ov_DynamicPtrCast(dynov_dynvariable, pchild);
		if (!pdynvar) return FALSE;
		Ov_GetVTablePtr(dynov_dynvariable, pvtable, pdynvar);
		result = pvtable->m_check(Ov_PtrUpCast(ov_object, pdynvar));
		if (!result) return FALSE;
		if (pdynvar->v_varprops & OV_VP_DERIVED) return FALSE;
		pdynvar->v_offset = pdynstruct->v_size;
		pdynstruct->v_size += pdynvar->v_size;
	}
	if (!pdynstruct->v_size) return FALSE;
	return TRUE;
}


OV_DLLFNCEXPORT OV_BOOL dynov_dynstructure_isinstantiable_get(
             OV_INSTPTR_dynov_dynstructure          pobj
) {
             return pobj->v_isinstantiable;
}

OV_DLLFNCEXPORT OV_RESULT dynov_dynstructure_isinstantiable_set(
             OV_INSTPTR_dynov_dynstructure          pobj,
             const OV_BOOL           value
) {
             OV_INSTPTR_ov_variable          	pvar;
             OV_INSTPTR_dynov_dynclass         	pdynclass;

	     if ((value) && (!pobj->v_isinstantiable)) {
	             pobj->v_isinstantiable = dynov_dynstructure_check(Ov_PtrUpCast(ov_object,pobj));
		     if (!pobj->v_isinstantiable) return OV_ERR_STRUCTDEFMISMATCH;
	     }
	     else if ((!value) && (pobj->v_isinstantiable)) {
		     Ov_ForEachChild(ov_construction, pobj, pvar) {
			     pdynclass = Ov_DynamicPtrCast(dynov_dynclass, Ov_GetParent(ov_containment, pvar));
			     if (pdynclass) if (pdynclass->v_isinstantiable) return OV_ERR_NOACCESS;
		     }
		     pobj->v_isinstantiable = FALSE;
	     }

       	     return OV_ERR_OK;
}

OV_DLLFNCEXPORT OV_ACCESS dynov_dynstructure_getaccess(
	OV_INSTPTR_ov_object	pobj,
	const OV_ELEMENT		*pelem,
	const OV_TICKET			*pticket
) {
	OV_INSTPTR_dynov_dynstructure	pdynstructure;
	OV_ACCESS			access;
	OV_ACCESS			access2;
		
	pdynstructure = Ov_StaticPtrCast(dynov_dynstructure, pobj);
	switch(pelem->elemtype) {
		case OV_ET_VARIABLE:
			if (!ov_string_compare(pelem->elemunion.pvar->v_identifier, "isinstantiable")) 
				return OV_AC_READ | OV_AC_WRITE;
			access = OV_AC_NONE;
			if (pdynstructure->v_isinstantiable) access = OV_AC_READ;
			else access = OV_AC_READ | OV_AC_WRITE;
			if (!ov_string_compare(pelem->elemunion.pvar->v_identifier, "size"))
				return access;
			return OV_AC_NONE;
		case OV_ET_CHILDLINK:
			return OV_AC_NONE;
		case OV_ET_PARENTLINK:
			if (pdynstructure->v_isinstantiable) {
				access = OV_AC_READ;
				access2 = OV_AC_READ;
			}
			else  {
				access = OV_AC_READ | OV_AC_WRITE;
				access2 = OV_AC_READ;
			}
			if (pelem->elemunion.passoc == passoc_ov_construction)
				return access2;
			if (pelem->elemunion.passoc == passoc_dynov_dynconstruction)
				return access;
			return OV_AC_NONE;
    	}
	if ((pdynstructure->v_isinstantiable) || (pobj->v_pouterobject)) return OV_AC_READ;
	return OV_AC_READ | OV_AC_WRITE | OV_AC_DELETEABLE | OV_AC_RENAMEABLE;
}

